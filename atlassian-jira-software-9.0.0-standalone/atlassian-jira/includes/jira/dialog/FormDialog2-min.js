define("jira/dialog/form-dialog2",["jira/util/formatter","jira/dialog/dialog2","jira/flag","jira/message","jira/ajs/ajax/smart-ajax","jira/focus/set-focus","jira/util/browser","jira/util/events","jquery","jira/libs/parse-uri"],function(t,e,s,i,n,o,r,a,u,l){"use strict";return e.extend({defineResources:function(){this._super.apply(this,arguments),this.isIssueDialog()&&this.requireContext("jira.edit.issue")},_getDefaultOptions:function(){return u.extend(this._super(),{autoClose:!1,targetUrl:"",refreshOnSubmit:!0,onUnSuccessfulSubmit:function(){},onSuccessfulSubmit:function(){},onDialogFinished:function(){var t=this._getTargetUrlValue();this.hide(),t?(a.trigger("page-unload.location-change.from-dialog",[this.$popup]),window.location.href=t):this.options.refreshOnSubmit&&(a.trigger("page-unload.refresh.from-dialog",[this.$popup]),r.reloadViaWindowLocation())},submitAjaxOptions:{type:"post",data:{inline:!0,decorator:"dialog"},dataType:"html"},isIssueDialog:!1})},_getFormDataAsObject:function(){var t={};return u(this.$form.serializeArray()).each(function(){var e=t[this.name];e?u.isArray(e)?e.push(this.value):e=[e,this.value]:e=this.value,t[this.name]=e}),t},_getRelativePath:function(){var t=this._getRequestOptions();return l(t.url).directory},_getPath:function(t){var e=this._getRelativePath();return 0===t.indexOf(e)?t:e+t},_submitForm:function(t){this.cancelled=!1,this.xhr=null,this.redirected=!1,this.serverIsDone=!1;var e=this,s=u.extend(!0,{},this.options.submitAjaxOptions),i=u.extend(!0,s,{url:this._getPath(this.$form.attr("action")),data:this._getFormDataAsObject(),complete:function(t,s,i){e.hideFooterLoadingIndicator(),e.cancelled||(e._showMessagesFromXhrResponse(t),i.successful?(e.$form.trigger("fakesubmit"),e._handleServerSuccess(i.data,t,s,i),e.redirected||e._handleSubmitResponse(i.data,t,i)):e._handleServerError(t,s,i.errorThrown,i)),e.$form.removeClass("submitting")}});i.data.decorator="dialog",i.data.inline=!0,this.showFooterLoadingIndicator(),this.xhr=n.makeRequest(i),t.preventDefault()},_showMessagesFromXhrResponse:function(t){var e=t.getResponseHeader("X-Atlassian-Messages");if(e){var i=JSON.parse(e);s.showMessages(i)}},_handleServerError:function(t,e,s,i){this.options.onUnSuccessfulSubmit&&this.options.onUnSuccessfulSubmit.call(t,e,s,i);var o=n.buildDialogErrorContent(i,!0),r=this.get$popupContent().find(".form-body");1!==r.length&&(r=this.get$popupContent()),1!==r.length||i.hasData?this.setSubmitResponseContent(o):r.prepend(o)},setSubmitResponseContent:function(t){this.options.formatSubmitResponseContent&&(t=this.options.formatSubmitResponseContent.call(this,t)),this._setContent(t)},isIssueDialog:function(){return!!this.options.isIssueDialog},_handleServerSuccess:function(t,e,s,n){var o=this._detectMsgInstructions(e),r=this._detectRedirectInstructions(e);this.serverIsDone=r.serverIsDone,o&&(r.redirectUrl||this._getTargetUrlValue()||this.options.refreshOnSubmit?i.showMsgOnReload(o.msg,{type:o.type,closeable:o.closeable,target:o.target}):i.showMsg(o.msg,{type:o.type.toLowerCase(),closeable:o.closeable,target:o.target})),r.redirectUrl?(this.options.onSuccessfulSubmit&&this.options.onSuccessfulSubmit.call(this,t,e,s,n),this._performRedirect(r.redirectUrl)):this.serverIsDone||this.setSubmitResponseContent(t)},_detectMsgInstructions:function(t){var e={msg:t.getResponseHeader("X-Atlassian-Dialog-Msg-Html")};if(e.msg)return e.type=t.getResponseHeader("X-Atlassian-Dialog-Msg-Type").toUpperCase(),e.closeable="true"===t.getResponseHeader("X-Atlassian-Dialog-Msg-Closeable"),e.target=t.getResponseHeader("X-Atlassian-Dialog-Msg-Target"),e},_handleInitialDoneResponse:function(t,e,s){this._handleSubmitResponse(t,e,s)},_handleSubmitResponse:function(t,e,s){this.serverIsDone&&(this.options.onSuccessfulSubmit&&this.options.onSuccessfulSubmit.call(this,t,e,s),this.options.autoClose&&this.hide(),this.options.onDialogFinished&&this.options.onDialogFinished.call(this,t,e,s))},_performRedirect:function(t){this.options.stayVisibleOnRedirect||this.hide(),this.redirected=!0,this._super(t)},_hasTargetUrl:function(){return this._getTargetUrlHolder().length>0},_getTargetUrlHolder:function(){return u(this.options.targetUrl)},_getTargetUrlValue:function(){return this._getTargetUrlHolder().val()},decorateContent:function(){var s,i,n,o,r,a=this;this.$form=u("form",this.get$popupContent()),this._constructHeading(),this.$form.submit(function(t){var e=new u.Event("before-submit");if(a.$form.trigger(e,[t,a]),e.isDefaultPrevented())t.preventDefault();else{a.$form.addClass("submitting");u(":submit",a).attr("disabled","disabled"),a.options.submitHandler?(a.showFooterLoadingIndicator(),a.options.submitHandler.call(a,t,function(){a.isCurrent()&&(a.hideFooterLoadingIndicator(),a.$form.removeClass("submitting"))})):a._submitForm(t)}}),i=u(".cancel",this.get$popupContent()),i.click(function(t){a.xhr&&a.xhr.abort(),a.xhr=null,a.cancelled=!0,a.hide(!0,{reason:e.HIDE_REASON.cancel}),t.preventDefault()}),s=this.get$popupContent().find(".button, .aui-button"),n=this.get$popupContent().find("div.buttons"),0===i.length&&0===s.length&&(0===n.length&&(o=u('<div class="buttons-container form-footer"><div class="buttons"/></div>').appendTo(this.get$popupContent()),n=o.find(".buttons")),AJS.populateParameters(),r=u("<button class='aui-button aui-button-link cancel' id='aui-dialog-close'>"+t.I18n.getText("admin.common.words.close")+"</button>"),n.append(r),r=u(".cancel",this.get$popupContent()),r.click(function(t){a.hide(!0,{reason:e.HIDE_REASON.cancel}),t.preventDefault()})),n.prepend(u("<span class='throbber'/>")),this.get$popupContent().on("click",".shortcut-tip-trigger",function(e){e.preventDefault(),a.get$popupContent().isDirty()&&!confirm(t.I18n.getText("common.forms.dirty.dialog.message"))||(a.hide(),u("#keyshortscuthelp").click())}),o instanceof u||(o=n.closest(".buttons-container, .form-footer"),o.size()||(o=n)),this.moveFooterToDialog2(o),this.$buttonContainer=o},getButtonsContainer:function(){return this.$buttonContainer},_constructHeading:function(){var t,e;if(t=u(":header:first",this.get$popupContent()),t.length>0)for(this.addHeading(t.contents()),e=t.parent(),t.remove();e.is(":empty");)t=e.parent(),e.remove(),e=t},hide:function(t,e){if(!1===this._super(t,e))return!1;o.popConfiguration()}})});