define("jira/dialog/form-dialog",["jira/util/formatter","jira/dialog/dialog","jira/flag","jira/message","jira/ajs/ajax/smart-ajax","jira/focus/set-focus","jira/util/browser","jira/util/events","jira/skate","jquery","jira/libs/parse-uri"],function(t,e,i,s,n,o,r,a,u,l,c){"use strict";return e.extend({defineResources:function(){this._super.apply(this,arguments),this.isIssueDialog()&&this.requireContext("jira.edit.issue")},_getDefaultOptions:function(){return l.extend(this._super(),{autoClose:!1,targetUrl:"",refreshOnSubmit:!0,onUnSuccessfulSubmit:function(){},onSuccessfulSubmit:function(){},onDialogFinished:function(){var t=this._getTargetUrlValue();this.hide(),t?(a.trigger("page-unload.location-change.from-dialog",[this.$popup]),window.location.href=t):this.options.refreshOnSubmit&&(a.trigger("page-unload.refresh.from-dialog",[this.$popup]),r.reloadViaWindowLocation())},submitAjaxOptions:{type:"post",data:{inline:!0,decorator:"dialog"},dataType:"html"},isIssueDialog:!1})},_getFormDataAsObject:function(){var t={};return l(this.$form.serializeArray()).each(function(){var e=t[this.name];e?l.isArray(e)?e.push(this.value):e=[e,this.value]:e=this.value,t[this.name]=e}),t},_getRelativePath:function(){var t=this._getRequestOptions();return c(t.url).directory},_getPath:function(t){var e=this._getRelativePath();return 0===t.indexOf(e)?t:e+t},_submitForm:function(t){this.cancelled=!1,this.xhr=null,this.redirected=!1,this.serverIsDone=!1;var e=this,i=l.extend(!0,{},this.options.submitAjaxOptions),s=l.extend(!0,i,{url:this._getPath(this.$form.attr("action")),data:this._getFormDataAsObject(),complete:function(t,i,s){e.hideFooterLoadingIndicator(),e.cancelled||(e._showMessagesFromXhrResponse(t),s.successful?(e.$form.trigger("fakesubmit"),e._handleServerSuccess(s.data,t,i,s),e.redirected||e._handleSubmitResponse(s.data,t,s)):e._handleServerError(t,i,s.errorThrown,s)),e.$form.removeClass("submitting")}});s.data.decorator="dialog",s.data.inline=!0,this.showFooterLoadingIndicator(),this.xhr=n.makeRequest(s),t.preventDefault()},_showMessagesFromXhrResponse:function(t){var e=t.getResponseHeader("X-Atlassian-Messages");if(e){var s=JSON.parse(e);i.showMessages(s)}},_handleServerError:function(t,e,i,s){this.options.onUnSuccessfulSubmit&&this.options.onUnSuccessfulSubmit.call(t,e,i,s);var o=n.buildDialogErrorContent(s,!0),r=this.get$popupContent().find(".form-body");1!==r.length&&(r=this.get$popupContent()),1!==r.length||s.hasData?this.setSubmitResponseContent(o):r.prepend(o)},setSubmitResponseContent:function(t){this.options.formatSubmitResponseContent&&(t=this.options.formatSubmitResponseContent.call(this,t)),this._setContent(t)},isIssueDialog:function(){return!!this.options.isIssueDialog},_handleServerSuccess:function(t,e,i,n){var o=this._detectMsgInstructions(e),r=this._detectRedirectInstructions(e);this.serverIsDone=r.serverIsDone,o&&(r.redirectUrl||this._getTargetUrlValue()||this.options.refreshOnSubmit?s.showMsgOnReload(o.msg,{type:o.type,closeable:o.closeable,target:o.target}):s.showMsg(o.msg,{type:o.type.toLowerCase(),closeable:o.closeable,target:o.target})),r.redirectUrl?(this.options.onSuccessfulSubmit&&this.options.onSuccessfulSubmit.call(this,t,e,i,n),this._performRedirect(r.redirectUrl)):this.serverIsDone||this.setSubmitResponseContent(t)},_detectMsgInstructions:function(t){var e={msg:t.getResponseHeader("X-Atlassian-Dialog-Msg-Html")};if(e.msg)return e.type=t.getResponseHeader("X-Atlassian-Dialog-Msg-Type").toUpperCase(),e.closeable="true"===t.getResponseHeader("X-Atlassian-Dialog-Msg-Closeable"),e.target=t.getResponseHeader("X-Atlassian-Dialog-Msg-Target"),e},_handleInitialDoneResponse:function(t,e,i){this._handleSubmitResponse(t,e,i)},_handleSubmitResponse:function(t,e,i){this.serverIsDone&&(this.options.onSuccessfulSubmit&&this.options.onSuccessfulSubmit.call(this,t,e,i),this.options.autoClose&&this.hide(),this.options.onDialogFinished&&this.options.onDialogFinished.call(this,t,e,i))},_performRedirect:function(t){this.options.stayVisibleOnRedirect||this.hide(),this.redirected=!0,this._super(t)},_hasTargetUrl:function(){return this._getTargetUrlHolder().length>0},_getTargetUrlHolder:function(){return l(this.options.targetUrl)},_getTargetUrlValue:function(){return this._getTargetUrlHolder().val()},decorateContent:function(){var i,s,n,o,r,a=this;this.$form=l("form",this.get$popupContent()),this._constructHeading(),this.$form.submit(function(t){var e=new l.Event("before-submit");if(a.$form.trigger(e,[t,a]),e.isDefaultPrevented())t.preventDefault();else{a.$form.addClass("submitting");l(":submit",a.$form).attr("disabled","disabled"),a.options.submitHandler?(a.showFooterLoadingIndicator(),a.options.submitHandler.call(a,t,function(){a.isCurrent()&&(a.hideFooterLoadingIndicator(),a.$form.removeClass("submitting"))})):a._submitForm(t)}}),s=l(".cancel",this.get$popupContent()),s.click(function(t){a.xhr&&a.xhr.abort(),a.xhr=null,a.cancelled=!0,a.hide(!0,{reason:e.HIDE_REASON.cancel}),t.preventDefault()}),i=this.get$popupContent().find(".button, .aui-button"),n=this.get$popupContent().find("div.buttons"),0===s.length&&0===i.length&&(0===n.length&&(o=l('<div class="buttons-container form-footer"><div class="buttons"/></div>').appendTo(this.get$popupContent()),n=o.find(".buttons")),AJS.populateParameters(),r=l("<button class='aui-button aui-button-link cancel' id='aui-dialog-close'>"+t.I18n.getText("admin.common.words.close")+"</button>"),n.append(r),r=l(".cancel",this.get$popupContent()),r.click(function(t){a.hide(!0,{reason:e.HIDE_REASON.cancel}),t.preventDefault()})),n.prepend(l("<span class='throbber'/>")),this.get$popupContent().on("click",".shortcut-tip-trigger",function(e){e.preventDefault(),a.get$popupContent().isDirty()&&!confirm(t.I18n.getText("common.forms.dirty.dialog.message"))||(a.hide(),l("#keyshortscuthelp").click())}),o instanceof l||(o=n.closest(".buttons-container, .form-footer"),o.size()||(o=n)),this.$buttonContainer=o},getButtonsContainer:function(){return this.$buttonContainer},_constructHeading:function(){var t,e;if(t=l(":header:first",this.get$popupContent()),t.length>0)for(this.addHeading(t.contents()),e=t.parent(),t.remove();e.is(":empty");)t=e.parent(),e.remove(),e=t},_setContent:function(t,i){this._super(t,i),t&&e.current===this&&e.current===this&&this._focusFirstField()},_focusFirstField:function(t){var e=new o.FocusConfiguration;t?e.focusElementSelector=t:this.$activeTrigger&&this.$activeTrigger.attr("data-field")&&(e.focusElementSelector="[name='"+this.$activeTrigger.attr("data-field")+"']"),e.parentElementSelectors.unshift(".aui-dialog-content"),e.context=this.get$popup()[0],u.init&&u.init(e.context),o.pushConfiguration(e),o.triggerFocus(),o.triggerFocus()},hide:function(t,e){if(!1===this._super(t,e))return!1;o.popConfiguration()}})}),AJS.namespace("AJS.FormPopup",null,require("jira/dialog/form-dialog")),AJS.namespace("JIRA.FormDialog",null,require("jira/dialog/form-dialog"));