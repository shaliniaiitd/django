var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t};define("jira/dialog/dialog",["require"],function(t){"use strict";var e=t("jira/dialog/dialog-stack"),i=t("jira/ajs/control"),o=t("jira/ajs/layer/inline-layer"),s=t("jira/util/data/meta"),n=t("jira/ajs/ajax/smart-ajax"),r=t("jira/loading/loading"),a=t("jira/xsrf"),d=t("jira/util/browser"),h=t("jira/util/events"),l=t("jira/util/navigator"),p=t("aui/dropdown"),c=t("jquery"),u=t("jira/jquery/deferred"),g=t("jira/jquery/plugins/isdirty"),f=t("underscore"),_=t("wrm/require"),m=t("jira/util/key-code"),v=AJS.bind,y=AJS.unbind,C=AJS.dim,w=AJS.layer,D=AJS.LayerManager.global,b=i.extend({_getDefaultOptions:function(){return{height:"auto",cached:!1,widthClass:"medium",modeless:!1,ajaxOptions:{data:{inline:!0,decorator:"dialog"}}}},init:function(t){if("string"==typeof t||t instanceof c?t={trigger:t}:t&&t.width&&(t.widthClass="custom"),this.classNames=b.ClassNames,this.OPEN_DIALOG_SELECTOR="."+this.classNames.DIALOG+"."+this.classNames.DIALOG_OPEN,this.options=c.extend(!0,this._getDefaultOptions(),t),this.options.width=b.WIDTH_PRESETS[this.options.widthClass]||t.width,this._setType(),this.options.trigger){var e=c.makeArray(this.options.trigger),i=this;c.each(e,function(t,e){i._assignEvents("trigger",e)})}this.onContentReadyCallbacks=[],this.initModeless(),this.defineResources(),this.options.prefetchResources&&this.downloadResources()},_setType:function(){"function"==typeof this.options.content?this.options.type="builder":this.options.content instanceof c||"object"===_typeof(this.options.content)&&this.options.nodeName?this.options.type="element":(!this.options.type&&!this.options.content||"object"===_typeof(this.options.content)&&this.options.content.url)&&(this.options.type="ajax")},initModeless:function(){this.options.modeless=!!this.options.modeless,this.options.modeless&&(!1===this.options.windowTitle&&(this.options.windowTitle=document.title),this._temporarilyHidden=!1,this._auiDialogShowHandler=this._auiDialogHandlers.hideTemporarily.bind(this),this._auiDialogHideHandler=this._auiDialogHandlers.restoreVisibility.bind(this),this._auiDialogRemoveHandler=this._auiDialogHandlers.restoreVisibilityRebindable.bind(this),v("show.dialog",this._auiDialogShowHandler),v("hide.dialog",this._auiDialogHideHandler),v("remove.dialog",this._auiDialogRemoveHandler),AJS.dialog2&&(this._auiDialog2ShowHandler=this._auiDialog2Handlers.hideTemporarily.bind(this),this._auiDialog2HideHandler=this._auiDialog2Handlers.restoreVisibility.bind(this),AJS.dialog2.on("show",this._auiDialog2ShowHandler),AJS.dialog2.on("hide",this._auiDialog2HideHandler)))},_runContentReadyCallbacks:function(){var t=this;c.each(this.onContentReadyCallbacks,function(){this.call(t)})},_setContent:function(t,i){var o;if("resolved"!==this.resourcesReady().state())return this._showloadingIndicator(),void this.resourcesReady().done(this._setContent.bind(this,t,i));t?e.current===this?(this.get$popup().show().css("visibility","hidden").addClass("popup-width-"+this.options.widthClass),this.$content=t,this.get$popupContent().html(t),!1!==i&&this.decorateContent&&this.decorateContent(),(o=this.get$popupContent().find("."+this.classNames.HEADING_AREA)).size()>0&&this.get$popupHeading().replaceWith(o),(o=this.get$popupContent().find("."+this.classNames.CONTENT_AREA)).size()>0&&(o.contents().insertAfter(o),o.remove()),this._positionInCenter(),!1!==i&&(c(document).trigger("dialogContentReady",[this]),this._runContentReadyCallbacks()),this.get$popup().css("visibility",""),!1!==i&&c.isFunction(this.options.onContentRefresh)&&this.options.onContentRefresh.call(this),this._onShowContent()):!1===this.options.cached&&delete this.$content:this._contentRetrievers[this.options.type].call(this,this._setContent)},_ellipsify:function(t){t instanceof c||(t=this.get$popup()),c(".overflow-ellipsis",t).textOverflow({className:"ellipsified"})},_handleInitialDoneResponse:function(t,e,i){},getRequestUrlFromTrigger:function(){if(this.$activeTrigger&&this.$activeTrigger.length)return this.$activeTrigger.attr("href")||this.$activeTrigger.data("url")},_getRequestOptions:function(){var t={};return!1!==this._getAjaxOptionsObject()&&(t=c.extend(!0,t,this._getAjaxOptionsObject()),t.url||(t.url=this.getRequestUrlFromTrigger()),t)},_getAjaxOptionsObject:function(){var t=this.options.ajaxOptions;return c.isFunction(t)?t.call(this):t},_contentRetrievers:{element:function(t){this.$content||(this.$content=c(this.options.content).clone(!0)),t.call(this,this.$content)},builder:function(t){var e=this;this.$content||(this._showloadingIndicator(),this.options.content.call(this,function(i){e.$content=c(i),t.call(e,e.$content)},function(){e._hideloadingIndicator()}))},ajax:function(t){var e,i=this;this.$content||(e=this._getRequestOptions(),this._showloadingIndicator(),this.serverIsDone=!1,e.complete=function(o,s,r){if(r.successful){var a=i._detectRedirectInstructions(o);i.serverIsDone=a.serverIsDone,a.redirectUrl?i._performRedirect(a.redirectUrl):(e.dataType&&"json"===e.dataType.toLowerCase()&&i._buildContentFromJSON?i.$content=i._buildContentFromJSON(r.data):i.$content=r.data,i.serverIsDone?i._handleInitialDoneResponse(r.data,o,r):t.call(i,i.$content))}else{var d=n.buildDialogErrorContent(r);t.call(i,d)}},n.makeRequest(e))}},_detectRedirectInstructions:function(t){var e={serverIsDone:!1,redirectUrl:""},i=t.getResponseHeader("X-Atlassian-Dialog-Control");if(i){e.serverIsDone=!0;0===i.indexOf("redirect:")?e.redirectUrl=i.substr("redirect:".length):"permissionviolation"===i&&(e.redirectUrl=window.location.href)}return e},_performRedirect:function(t){d.reloadViaWindowLocation(t)},_renders:{popupHeading:function(){return c("<div />").addClass(this.classNames.HEADING_AREA).addClass("jira-dialog-core-heading")},popupContent:function(){return c("<div />").addClass(this.classNames.CONTENT_AREA).addClass("jira-dialog-core-content")},popup:function(){return c("<div />").attr("id",this.options.id||"").addClass(this.classNames.DIALOG).addClass("jira-dialog-core").toggleClass(this.classNames.MODELESS_DIALOG,this.options.modeless).hide()}},_events:{trigger:{simpleClick:function(t,e){this.$activeTrigger=e,this.$activeTrigger.is("a")||(this.$activeTrigger=e.find("a")),this.show(),t.preventDefault()}},container:{keydown:function(t){if(t.which===m.ESCAPE){var i=this.handleCancel();l.isIE()&&l.majorVersion()<12&&!1===i&&t.preventDefault()}t.keyCode===m.TAB&&e.current._watchTab(t)}}},handleCancel:function(){return this.hide(!0,{reason:b.HIDE_REASON.escape})},_showloadingIndicator:function(){r.showLoadingIndicator()},_hideloadingIndicator:function(){r.hideLoadingIndicator()},_positionInCenter:function(){var t=c(window),e=this.get$popup(),i=this.getContentContainer(),o=this.getContentArea(),s=t.height(),n=0;if("number"==typeof this.options.width&&e.width(this.options.width),this.options.modeless)n=Math.round(s/2);else{e.css({marginLeft:-e.outerWidth()/2,marginTop:Math.max(-e.outerHeight()/2,40-s/2)});for(var r=e[0];r;)n+=r.offsetTop,r=r.offsetParent}var a=Math.max(s-n-40,b.CONSTRAINTS.MODELESS_MIN_HEIGHT),d=parseInt(o.css("padding-top"),10)+parseInt(o.css("padding-bottom"),10);o.css("maxHeight","");var h=a-(e.outerHeight()-i.outerHeight())-d;o.css("maxHeight",h),c(this).trigger("contentMaxHeightChanged",[h])},getContentArea:function(){return this.$popup.find(".form-body")},getContentContainer:function(){var t=this.$popup.find(".content-area-container");return 1===t.length?t:this.$popup.find(".form-body")},get$popup:function(){return this.$popup||(this.$popup=this._render("popup").appendTo("body"),this.$popup.addClass("box-shadow")),this.$popup},bindAnchorsToDialog:function(t){var e=this;t.click(function(t){e.$activeTrigger=c(this),delete e.$content,e._setContent(),t.preventDefault()})},get$popupContent:function(){return this.$popupContent||(this.$popupContent=this._render("popupContent").appendTo(this.get$popup())),this.$popupContent},get$popupHeading:function(){return this.$popupHeading||(this.$popupHeading=this._render("popupHeading").prependTo(this.get$popup())),this.$popupHeading},getLoadingIndicator:function(){return this.get$popupContent().find(".throbber:last")},showFooterLoadingIndicator:function(){var t=this.getLoadingIndicator();t.length&&(t.data("spinner")?t.hasClass("loading")||t.addClass("loading"):t.addClass("loading").spin())},hideFooterLoadingIndicator:function(){var t=this.getLoadingIndicator();t.length&&(t.removeClass("loading"),f.defer(function(){t.hasClass("loading")||t.spinStop()}))},_watchTab:function(t){var e,i,o;c(t.target).parents(this.get$popupContent()).length>0&&(e=c("html").hasClass("safari")?c(":input:visible:enabled, :checkbox:visible:enabled, :radio:visible:enabled",this.OPEN_DIALOG_SELECTOR):c("a:visible, :input:visible:enabled, :checkbox:visible:enabled, :radio:visible:enabled",this.OPEN_DIALOG_SELECTOR),i=e.first(),o=e.last(),(t.target===i[0]&&t.shiftKey||t.target===o[0]&&!t.shiftKey)&&(t.shiftKey?o.focus():i.focus(),t.preventDefault()))},_hideCurrentInlineLayer:function(){o.current&&o.current.hide()},_hideCurrentAuiDropdown:function(){p.current&&p.current.hide()},_show:function(t){this._hideCurrentInlineLayer(),this._hideCurrentAuiDropdown();var i=e.current;if(i){var o;if(i.options.stacked)o=i,o.stacked=!0,o.hide(!1),this.prev=o;else{e.stackroot=this;var s=e.current;for(o=s._removeStackState(),s.hide(!1);o;)s=o,o=s._removeStackState(),s._destroyIfNecessary()}}else!0!==this.stacked&&(e.stackroot=this,e.originalWindowTitle=document.title);this.options.modeless||(this.prev&&this.prev.options.modeless?C(!1):!0!==this.stacked&&C(!1)),e.current=this;var n=this.get$popup().addClass(this.classNames.DIALOG_OPEN);t||"blank"!==this.options.type&&!this.$content&&!0!==this.stacked?(delete this.$content,this._setContent()):(n.show(),this._positionInCenter(),this._onShowContent()),this._assignEvents("container",document),c(this).trigger("Dialog.show",[this.$popup,this,this.id]),h.trigger("Dialog.show",[this.$popup,this,this.id]),this.options.modeless||d.disableKeyboardScrolling(),this.stacked=!1},show:function(t){var i=this.options.delayShowUntil,o=this;if(e.current===this)return!1;var s=new c.Event("beforeShow"),n=new c.Event("beforeShow");if(c(this).trigger(s),h.trigger(n,[this.options.id]),s.isDefaultPrevented()||n.isDefaultPrevented())return!1;if(this.downloadResources(),i){var r=i();"resolved"===r.state()?o._show(t):(this.options.modeless||C(!1),this._showloadingIndicator(),r.done(function(){o._show(t)}))}else o._show(t)},_setWindowTitle:function(){var t,e,i=this.options.windowTitle,o=this.get$popup();if(!1!==i&&("string"==typeof i?t=i:"function"==typeof i?t=i.call(this):(e=o.find("."+this.classNames.HEADING_AREA),e.length&&(t=e.text())),t)){var n=s.get("app-title"),r=[t];n&&r.push(n),document.title=r.join(" - ")}},_onShowContent:function(){this._setWindowTitle(),this._hideloadingIndicator(),this._ellipsify(),this.get$popup().addClass(this.classNames.CONTENT_READY)},_resetWindowTitle:function(){!0!==this.stacked&&e.stackroot===this&&e.originalWindowTitle&&(document.title!==e.originalWindowTitle&&(document.title=e.originalWindowTitle),e.originalWindowTitle=void 0)},notifyOfNewContent:function(){this.$content&&(this.decorateContent(),this._positionInCenter(),this._onShowContent(),c(document).trigger("dialogContentReady",[this]))},destroy:function(){this.options.modeless&&(AJS.dialog2&&(AJS.dialog2.off("show",this._auiDialog2ShowHandler),AJS.dialog2.off("hide",this._auiDialog2HideHandler),delete this._auiDialog2ShowHandler,delete this._auiDialog2HideHandler),y("show.dialog",this._auiDialogShowHandler),y("hide.dialog",this._auiDialogHideHandler),y("remove.dialog",this._auiDialogRemoveHandler),delete this._auiDialogShowHandler,delete this._auiDialogHideHandler,delete this._auiDialogRemoveHandler),this.$popup&&this.$popup.remove(),delete this.$popup,delete this.$popupContent,delete this.$popupHeading,delete this.$content},_destroyIfNecessary:function(){!this.options.cached&&this.destroy()},_removeStackState:function(){var t=this.prev;return delete this.prev,delete this.stacked,t},isCurrent:function(){return e.current===this},hide:function(t,i){if(e.current===this){var o=new c.Event("Dialog.beforeHide"),s=new c.Event("Dialog.beforeHide");if(i=i||{},h.trigger(o,[this.$popup,i.reason,this.options.id]),c(this).trigger(s,[this.$popup,i.reason,this.options.id]),o.isDefaultPrevented()||s.isDefaultPrevented())return!1;this._updateXSRFToken(),(!1!==t&&!this.prev&&!this.options.modeless||this.prev&&this.prev.options.modeless)&&AJS.undim(),this.get$popup().removeClass(this.classNames.DIALOG_OPEN).removeClass(this.classNames.CONTENT_READY).hide(),this._hideloadingIndicator(),this._resetWindowTitle(),this._unassignEvents("container",document),c(document).trigger("hideAllLayers",[this.$popup,i.reason,this.options.id]),c(this).trigger("Dialog.hide",[this.$popup,i.reason,this.options.id]),h.trigger("Dialog.hide",[this.$popup,i.reason,this.options.id]),e.current=null,!1===this.options.cached&&!0!==this.stacked&&this.destroy(),this.options.modeless||d.enableKeyboardScrolling(),!0!==this.stacked&&(this.prev?(this.prev.show(!!this.prev.options.reloadOnPop),delete this.prev):e.stackroot===this&&(e.stackroot=void 0))}},_updateXSRFToken:function(){var t=c("input[name=atl_token]",this.OPEN_DIALOG_SELECTOR).attr("value");void 0!==t&&a.updateTokenOnPage(t)},addHeading:function(t){var e=c("<div/>").html(t).contents(),i=c("<h2/>"),o=[];e.each(function(){"div"===this.nodeName.toLowerCase()?o.push(this):i.append(this)}),this.get$popupHeading().html(o).prepend(i),i.attr("title",c.trim(i.text()))},onContentReady:function(t){c.isFunction(t)&&this.onContentReadyCallbacks.push(t)},_auiDialogHandlers:{hideTemporarily:function(){this._temporarilyHidden||this._hideTemporarily()},restoreVisibility:function(){if(this._temporarilyHidden){var t=D.getTopLayer(),e=!!t&&w(t);e&&e.isVisible()&&e.isBlanketed()||this._restoreVisibility()}},restoreVisibilityRebindable:function(t,e){this._restoreVisibility(t,e);var i=function(){v("remove.dialog",this._auiDialogRemoveHandler)};setTimeout(i.bind(this),0)}},_auiDialog2Handlers:{hideTemporarily:function(){this._temporarilyHidden||this._hideTemporarily()},restoreVisibility:function(){if(this._temporarilyHidden&&(!AJS.popup.current||!AJS.popup.current.element.is(":visible"))){AJS.LayerManager.global.getTopLayer()||this._restoreVisibility()}}},_hideTemporarily:function(){this.get$popup().addClass(this.classNames.DIALOG_NOT_VISIBLE),this._temporarilyHidden=!0},_restoreVisibility:function(){this.get$popup().removeClass(this.classNames.DIALOG_NOT_VISIBLE),this._temporarilyHidden=!1},defineResources:function(){f.isFunction(this.options.defineResources)&&this.options.defineResources.call(this)},requireContext:function(t){this.requireResource(t,"wrc!")},requireResource:function(t,e){this.wrmResources=this.wrmResources||[],this.wrmResources.push((e||"wr!")+t)},getRequiredResources:function(){return this.wrmResources||[]},downloadResources:function(){this.getRequiredResources().length>0&&!this.deferredResources&&(this.deferredResources=_(this.getRequiredResources()))},resourcesReady:function(){return this.deferredResources?this.deferredResources.promise():(new u).resolve().promise()}});return b.fn.dirtyFormWarning=function(){return this.bind("Dialog.beforeHide",function(t,e,i){if(!t.isDefaultPrevented()&&(i===b.HIDE_REASON.cancel||i===b.HIDE_REASON.escape)){var o=g.getDirtyWarning();o&&!confirm(o)&&t.preventDefault()}})},b.ClassNames={DIALOG:"jira-dialog",HEADING_AREA:"jira-dialog-heading",CONTENT_AREA:"jira-dialog-content",DIALOG_OPEN:"jira-dialog-open",CONTENT_READY:"jira-dialog-content-ready",MODELESS_DIALOG:"jira-dialog-modeless",DIALOG_NOT_VISIBLE:"jira-dialog-not-visible"},b.WIDTH_PRESETS={small:360,medium:540,large:810},b.CONSTRAINTS={MODELESS_MIN_HEIGHT:240},b.HIDE_REASON={cancel:"cancel",escape:"esc",submit:"submit"},Object.defineProperty(b,"current",{get:function(){return console.warn(e.currentDeprecationMsg),e.current},set:function(t){console.warn(e.currentDeprecationMsg),e.current=t}}),b}),AJS.namespace("AJS.FlexiPopup",null,require("jira/dialog/dialog")),AJS.namespace("JIRA.Dialog",null,require("jira/dialog/dialog"));