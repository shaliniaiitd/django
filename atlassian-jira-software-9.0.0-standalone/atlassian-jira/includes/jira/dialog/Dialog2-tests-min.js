AJS.test.require(["jira.webresources:jira-global","jira.webresources:jira-dialog-core-2"],function(){"use strict";var e=require("jquery"),t=require("underscore"),i=require("jira/dialog/dialog2"),o=require("jira/dialog/dialog-stack"),n=function(t,o){var n=e("<div>").css({height:"200px"}).append(e("<h2>").text(t)),r={content:function(e){return s.contentCall++,e(n)},height:"200px",windowTitle:t,id:t},s=new i(e.extend(r,o));return s.isVisible=function(){return n.is(":visible")},s.contentCall=0,s.title=t,s},r=function(e,t){return!e.$popup||!e.isVisible()||e.$popup.css("z-index")<t.$popup.css("z-index")},s=function(){ok(0===e(".jira-page-loading-indicator").length,"Throbber is removed when dialog is displayed")},a=function(e,t){return function(i){if(i){var o=i.title;ok(i.isVisible(),o+" visible?"),strictEqual(document.title,o,"Title correctly set to '"+o+"'."),s()}else strictEqual(document.title,t,"Title correctly reset.");for(var n=0;n<e.length;n++)e[n]!==i&&ok(r(e[n],i),e[n].title+" not visible?")}},l=function(e){return function(){for(var t=0;t<arguments.length;t++){var i=e[t];strictEqual(i.contentCall,arguments[t],"Content refreshed on '"+i.title+"' "+arguments[t]+" times?")}}};module("Dialog Tests",{teardown:function(){e("."+i.ClassNames.DIALOG).remove()}}),test("Stacks dialogs",function(){var e=n("Dialog3",{stacked:!0}),t=n("Dialog2",{stacked:!0}),i=n("Dialog1",{stacked:!0}),o=[i,t,e],r=document.title,s=document.title="Stacked Dialogs Test",d=a(o,s),c=l(o);i.show(),d(i),c(1,0,0),t.show(),d(t),c(1,1,0),e.show(),d(e),c(1,1,1),e.hide(),d(t),c(1,1,1),e.show(),d(e),c(1,1,2),e.hide(),d(t),c(1,1,2),t.hide(),d(i),c(1,1,2),i.hide(),d(null),c(1,1,2),t.show(),d(t),c(1,2,2),t.hide(),d(null),c(1,2,2),e.show(),d(e),c(1,2,3),i.show(),d(i),c(2,2,3),t.show(),d(t),c(2,3,3),t.hide(),d(i),c(2,3,3),i.hide(),d(e),c(2,3,3),t.show(),d(t),c(2,4,3),t.hide(),d(e),c(2,4,3),e.hide(),d(null),c(2,4,3),document.title=r}),test("Test Simple Dialog Title Change",function(){var e=n("Dialog1"),t=n("Dialog2"),i=document.title,o=document.title="Test Dialog Title",r=function(e){e?strictEqual(document.title,e.title,e.title+" title correct?"):strictEqual(document.title,o,"Original Title Restored?")};e.show(),r(e),t.show(),r(t),t.hide(),r(null),e.show(),r(e),t.show(),r(t),e.show(),r(e),e.hide(),r(null),document.title=i}),test("Test redirect instructions",function(){var e=n("Dialog1"),t={},i={getResponseHeader:function(e){return t[e]}},o=e._detectRedirectInstructions(i);deepEqual(o,{serverIsDone:!1,redirectUrl:""},"No header"),t["X-Atlassian-Dialog-Control"]="DONE",o=e._detectRedirectInstructions(i),deepEqual(o,{serverIsDone:!0,redirectUrl:""},"DONE header"),t["X-Atlassian-Dialog-Control"]="redirect:http://localhost.com",o=e._detectRedirectInstructions(i),deepEqual(o,{serverIsDone:!0,redirectUrl:"http://localhost.com"},"Redirect Header"),t["X-Atlassian-Dialog-Control"]="permissionviolation",o=e._detectRedirectInstructions(i),deepEqual(o,{serverIsDone:!0,redirectUrl:window.location.href},"Permision Voilation")}),module("Dialog headers",{setup:function(){this.$content=e("<p>Practically empty</p>"),this.dialog=new i({content:this.$content})},teardown:function(){this.dialog.hide(),this.$content.remove()}}),test("Can provide plain-text for the heading",function(){var e="This is my dialog heading. It is made from win and awesome.";this.dialog.addHeading(e),notEqual(this.dialog.get$popupHeading().text().indexOf(e),-1,"The title text should be present in the dialog")}),test("heading contents are placed inside known container",function(){this.dialog.addHeading("Quite full");var e=this.dialog.$popup.find(i.getSelector("HEADING_AREA"));equal(e.text(),"Quite full","The dialog's heading is inside an element with the HTML class from JIRA.Dialog.ClassNames.HEADING_AREA"),equal(e.find("h2").size(),1,"The dialog's heading is contained within an h2 element.")}),test("Can provide HTML for the heading",function(){var e="One flew <i>over</i> the <strong>cuckoo's</strong> nest";this.dialog.addHeading(e);var t=this.dialog.$popup.find(i.getSelector("HEADING_AREA"));equal(t.find("h2").html(),e,"HTML is preserved when added to the dialog heading")}),test("H2 is placed first inside the heading",function(){this.dialog.addHeading("<h2>Dialog title</h2><div>Some additional stuff</div>");var e=this.dialog.$popup.find(i.getSelector("HEADING_AREA"));equal(e.find(":first-child").prop("tagName"),"H2","H2 is the first element in the heading")}),test("H2 is placed first inside the heading regardless the order of elements provided",function(){this.dialog.addHeading("<div>Some additional stuff</div><h2>Dialog title</h2>");var e=this.dialog.$popup.find(i.getSelector("HEADING_AREA"));equal(e.find(":first-child").prop("tagName"),"H2","H2 is the first element in the heading")}),module("Dialog resources",{setup:function(){this.sandbox=sinon.sandbox.create();var t=e("<div>");this.dialogOptions={resources:["resource1","resource2"],contexts:["context1","context2"],content:function(e){return e(t)}},this.context=AJS.test.mockableModuleContext(),this.requireDeferred=new e.Deferred,this.wrmRequire=this.sandbox.stub(),this.context.mock("wrm/require",this.wrmRequire),this.Dialog=this.context.require("jira/dialog/dialog"),this.WRMDialog=this.Dialog.extend({defineResources:function(){this._super.apply(this,arguments),(this.options.resources||[]).forEach(function(e){this.requireResource(e)},this),(this.options.contexts||[]).forEach(function(e){this.requireContext(e)},this)}})},teardown:function(){this.sandbox.restore()}}),test("New dialog instance will not prefetch resources in constructor when prefetchResources field is not true",function(){new this.WRMDialog(this.dialogOptions),ok(this.wrmRequire.notCalled,"require not called")}),test("New dialog instance will prefetch resources in constructor when prefetchResources field is true",function(){new this.WRMDialog(t.extend(this.dialogOptions,{prefetchResources:!0})),ok(this.wrmRequire.calledOnce,"require called once"),deepEqual(this.wrmRequire.getCall(0).args[0],["wr!resource1","wr!resource2","wrc!context1","wrc!context2"],"WRM.require called with proper args")}),test("Show will not download resources if none specified",function(){var e=new this.WRMDialog;ok(this.wrmRequire.notCalled,"require not called after constructor"),e.show(),ok(this.wrmRequire.notCalled,"require not called after show"),e.hide()}),test("Show will download resources once if specified",function(){this.wrmRequire.returns(this.requireDeferred);var e=new this.WRMDialog(this.dialogOptions);ok(this.wrmRequire.notCalled,"require not called after constructor"),e.show(),ok(this.wrmRequire.calledOnce,"require called once"),deepEqual(this.wrmRequire.getCall(0).args[0],["wr!resource1","wr!resource2","wrc!context1","wrc!context2"],"WRM.require called with proper args"),e.hide(),e.show(),ok(this.wrmRequire.calledOnce,"require called once"),e.hide()}),test("Does not show dialog until resources resolved",function(){this.wrmRequire.returns(this.requireDeferred);var e=new this.WRMDialog(this.dialogOptions),t=this.sandbox.spy(e,"_onShowContent");ok(this.wrmRequire.notCalled,"require not called after constructor"),e.show(),ok(this.wrmRequire.calledOnce,"require called once"),ok(t.notCalled),this.requireDeferred.resolve(),ok(t.calledOnce,"showContent called after resources resolve"),e.hide()}),test("Dialog constructor should call options defineResources with itself in scope",function(){var e=this.sandbox.stub(),t=new this.Dialog({defineResources:e});ok(e.calledOnce,"defineResources was called once"),deepEqual(e.getCall(0).thisValue,t,"defineResources called with dialog as this.")}),module("_setContent",{teardown:function(){this.dialog.hide(),this.$content.remove()}}),test("should convert legacy footer to the new footer (AUI Dialog2)",function(){this.$content=e('<div>Dialog<div class="buttons">Legacy footer</div></div>');var t=this.$content.find(".buttons");this.dialog=new i({content:this.$content}),this.dialog.show();var o=this.dialog.$popup;equal(o.children().length,2,"Dialog contains two child elements");var n=o.children().get(1);equal(n.tagName,"FOOTER","Footer is created and put as the last child of the dialog"),equal(n.className,"aui-dialog2-footer","Footer has correct class name"),ok(e(n).children().get(0).isEqualNode(t[0]),"Footer has correct content")}),test("should promote footer outside main content area",function(){this.$content=e('<div>Dialog content<footer class="aui-dialog2-footer">AUI Dialog2 footer</footer></div>');var t=this.$content.find(".aui-dialog2-footer");this.dialog=new i({content:this.$content}),this.dialog.show();var o=this.dialog.$popup;equal(o.children().length,2,"Dialog contains two child elements");var n=o.children().get(1);ok(n.isEqualNode(t[0]),"Footer is promoted after dialog main content area")}),test("should promote heading outside main content area",function(){this.$content=e('<div>Dialog content<header class="aui-dialog2-header jira-dialog-core-heading">AUI Dialog2 header</header></div>');var t=this.$content.find(".aui-dialog2-header");this.dialog=new i({content:this.$content}),this.dialog.show();var o=this.dialog.$popup;equal(o.children().length,2,"Dialog contains two child elements");var n=o.children().get(0);ok(n.isEqualNode(t[0]),"Header is promoted before dialog main content area")}),test("should pull nested dialog content to the main content area",function(){this.$content=e('<div>Dialog content<div class="aui-dialog2-content jira-dialog-core-content"><div>AUI Dialog2 content</div></div></div>'),this.dialog=new i({content:this.$content}),this.dialog.show();var t=this.dialog.$popup;equal(t.children().length,1,"Dialog contains one child element");var o=t.find(".jira-dialog-core-content");equal(o.html(),"<div>Dialog content<div>AUI Dialog2 content</div></div>","Nested main content is pulled out and inserted to the root main content")}),module("DialogStack",{setup:function(){this.context=AJS.test.mockableModuleContext(),this.DialogStack=this.context.require("jira/dialog/dialog-stack")}}),test("[BC] Should support reading directly from `current` prop",function(){o.current=null,strictEqual(i.current,null)}),test("[BC] Should support writing directly to `current` prop",function(){var e={};o.current=null,i.current=e,strictEqual(i.current,e),strictEqual(o.current,e)})});