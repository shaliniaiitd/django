var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};AJS.test.require("jira.webresources:jira-global",function(){"use strict";var e=require("jquery"),t=require("jira/field/assignee-picker"),s=require("underscore");module("JIRA.AssigneePicker",{setup:function(){var t=e("#qunit-fixture");this.pickerSelect=e('<select id="assignee" name="assignee" class="single-user-picker js-assignee-picker aui-ss-select" data-show-dropdown-button="true" data-user-type="assignee" data-container-class="long-field" multiple="multiple" style="display: none;"><optgroup id="assignee-group-suggested" label="Suggestions" data-weight="0">  <option value="admin" data-field-text="admin" data-field-label="admin - admin@localhost (admin)" data-icon="/jira/secure/useravatar?size=xsmall&amp;avatarId=10122">admin</option>  <option value="" data-field-text="Unassigned" data-field-label="Unassigned" data-icon="/jira/secure/useravatar?size=xsmall&amp;avatarId=10123">Unassigned</option>  <option value="-1" data-field-text="Automatic" data-field-label="Automatic" data-icon="/jira/secure/useravatar?size=xsmall&amp;avatarId=10123">Automatic</option></optgroup></select>').appendTo(t),this.xhr=sinon.useFakeXMLHttpRequest();var i=this.requests=[];this.xhr.onCreate=function(e){i.push(e)};var r=0;this.testHelper={responseBuilder:function(e){for(var t=[],s=0;s<e;s++)t.push({name:"user"+r,displayName:"User "+r,emailAddress:"user"+r+"@local",avatarUrls:{"16x16":""}}),r++;return JSON.stringify(t)},scroll:function(e,t){e[0].scrollTop=t*e[0].scrollHeight/100,e.trigger("scroll")},respondWith:function(e){s.last(i).respond(200,{"Content-Type":"application/json"},this.responseBuilder(e))},urlFromLastRequest:function(){var e=s.last(i);return"object"===(void 0===e?"undefined":_typeof(e))?e.url:""},parseQueryString:function(e){return s.object(e.split("&").map(function(e){return e.split("=")}))},paramsFromLastRequest:function(){return this.parseQueryString(this.urlFromLastRequest().split("?")[1])}}},tearDown:function(){this.xhr.restore(),this.requests=[]}}),test("Selecting invalid Automatic assignee",function(){var e=new t({element:this.pickerSelect,editValue:"-1"});ok(!e.$container.hasClass("aui-ss-editing"),"input should not be in edit mode"),equal(e.$field.val(),"Automatic",'"Automatic" assignee should be displayed as string label')}),test("It should fetch the assignee list when the picker is opened",function(){var e=new t({element:this.pickerSelect});sinon.spy(e.suggestionsHandler.descriptorFetcher,"execute"),e._handleCharacterInput.call(e,!0),ok(e.suggestionsHandler.descriptorFetcher.execute.calledOnce,"AJAX called when the picker is opened"),equal(this.testHelper.paramsFromLastRequest().maxResults,100,"Fetches first items"),this.testHelper.respondWith(50),equal(e.listController.getAllItems().length,53,"Display 53  (3 suggestions + 50 new items)")}),test("It should debounce calls to the server",function(){var e=new t({element:this.pickerSelect}),s=sinon.useFakeTimers();e.$field.val("a"),e._handleCharacterInput(),e.$field.val("ab"),e._handleCharacterInput(),e.$field.val("abc"),e._handleCharacterInput(),equal(this.requests.length,0,"Requests are not made immediately"),s.tick(300),this.testHelper.respondWith(50),equal(this.requests.length,1,"Server is called once"),s.restore()}),test("It should NOT send request to server when user keeps clicking on the field",function(){var e=new t({element:this.pickerSelect}),i=e.$container.find("#assignee-field");sinon.spy(e.suggestionsHandler.descriptorFetcher,"execute"),stop(),s.delay(function(){i.click(),this.testHelper.respondWith(50),ok(e.suggestionsHandler.descriptorFetcher.execute.calledOnce,"Click on assignee field for the 1st time, request was sent to retrieve data"),i.click(),ok(e.suggestionsHandler.descriptorFetcher.execute.calledOnce,"Click on assignee field for the 2nd time, NO request was sent"),i.click(),ok(e.suggestionsHandler.descriptorFetcher.execute.calledOnce,"Click on assignee field for the 3rd time, NO request was sent"),start()}.bind(this),100)}),test("It should NOT deduplicate results",function(){var e=new t({element:this.pickerSelect});notOk(e.options.removeDuplicates,"Assignee picker does not deduplicate the results"),ok(e.options.disableRemoveSelected,"Assignee picker does not remove selected options from results")})});