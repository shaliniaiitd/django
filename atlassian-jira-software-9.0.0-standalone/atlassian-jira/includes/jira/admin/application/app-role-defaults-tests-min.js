AJS.test.require(["jira.webresources:application-roles"],function(){"use strict";require(["backbone","jquery"],function(e,t){function i(i){return new(e.Collection.extend({_faulty:!1,model:e.Model.extend({defaults:{name:null,groups:null,defaultGroups:null,selectedByDefault:!1,_faulty:!1},idAttribute:"key",update:function(){return this.get("_faulty")?(new t.Deferred).reject(this.toJSON()):(new t.Deferred).resolve(this.toJSON())}}),updateDefaults:function(){return this._faulty?(new t.Deferred).reject(this.toJSON()):(new t.Deferred).resolve(this.toJSON())}}))(i)}module("CompositeView Tests",{setup:function(){this.context=AJS.test.mockableModuleContext()}}),test("CompositeView.commit resolves after save",function(){var e=this.context.require("jira/admin/application/defaults/ApplicationListView"),t=i([{key:"role1"},{key:"role2"}]),o=new e({collection:t});o.render(),o.commit().then(function(){ok("Commit resolved after save")})}),test("CompositeView.commit resolves empty list",function(){var e=this.context.require("jira/admin/application/defaults/ApplicationListView"),t=i([]),o=new e({collection:t});o.render(),o.commit().then(function(){ok("Commit resolved after empty collection")})}),test("CompositeView.commit fails after unsuccessful save",function(){var e=this.context.require("jira/admin/application/defaults/ApplicationListView"),t=i([{key:"role1"},{key:"role2"}]);t._faulty=!0;var o=new e({collection:t});o.render(),o.commit().fail(function(){ok("Commit rejected after failed save")})})})}),AJS.test.require(["jira.webresources:application-roles"],function(){"use strict";require(["backbone","jquery","jira/admin/application/defaults/DialogView"],function(e,t,i){function o(e){return this.context.require("jira/admin/application/defaults/ApplicationListView").extend({commit:function(){return e}})}function n(t){return new(e.Collection.extend({model:e.Model.extend({defaults:{name:null,groups:null,defaultGroups:null,selectedByDefault:!1},idAttribute:"key"})}))(t)}module("DialogView Tests",{setup:function(){this.context=AJS.test.mockableModuleContext(),this.applicationCollection=n([{key:"roleOne"},{key:"roleTwo"},{key:"roleThree",defaultGroups:["defaultGroup"]}]),this.createDialogViewAndRenderIt=function(e,t){var o=new i({collection:e,webPanels:t||""});return o.warnings.show=sinon.spy(),o.render(),o}},teardown:function(){}}),test("Resolved commit should not display",function(){var e=o.call(this,(new t.Deferred).resolve().promise()),l=n([]),a=new i({collection:l});a.render(),a.showContents(new e({collection:this.applicationCollection})),a.formSubmit().done(function(){ok("Form submit succeeded"),strictEqual(a.errors,void 0,"Errors are not visible")})}),test("Failed commit should display error",function(){var e=o.call(this,(new t.Deferred).reject().promise(),[]),l=n([]),a=new i({collection:l});a.render(),a.showContents(new e({collection:this.applicationCollection})),equal(a.errors.$el,null,"Error region not present"),a.formSubmit().fail(function(){ok("Form submit failed"),equal(a.errors.$el.is(":not(:empty)"),!0,"Errors are visible")})}),test("Warning should open when one application doesn't have a default group",function(){var e=o.call(this);this.applicationCollection.get("roleOne").set("selectedByDefault",!0);var t=this.createDialogViewAndRenderIt(this.applicationCollection);t.showContents(new e({collection:this.applicationCollection})),ok(t.warnings.show.calledOnce)}),test("Warning should open when both applications don't have a default group",function(){var e=o.call(this);this.applicationCollection.get("roleOne").set("selectedByDefault",!0),this.applicationCollection.get("roleTwo").set("selectedByDefault",!0);var t=this.createDialogViewAndRenderIt(this.applicationCollection);t.showContents(new e({collection:this.applicationCollection})),ok(t.warnings.show.calledOnce)}),test("Warning should open when at least one application doesn't have a default group",function(){var e=o.call(this,null,["roleOne","roleTwo","roleThree"]);this.applicationCollection.get("roleOne").set("selectedByDefault",!0),this.applicationCollection.get("roleTwo").set("selectedByDefault",!0),this.applicationCollection.get("roleThree").set("selectedByDefault",!0);var t=this.createDialogViewAndRenderIt(this.applicationCollection);t.showContents(new e({collection:this.applicationCollection})),ok(t.warnings.show.calledOnce)}),test("Warning shouldn't open when all selected applications have a default group",function(){var e=o.call(this);this.applicationCollection.get("roleThree").set("selectedByDefault",!0);var t=this.createDialogViewAndRenderIt(this.applicationCollection);t.showContents(new e({collection:this.applicationCollection})),ok(!t.warnings.show.called)}),test("Dialog should render passed webPanels on showContents",function(){var e=o.call(this),i=this.createDialogViewAndRenderIt(this.applicationCollection,"fusion <b>awesome</b> content");i.showContents(new e({collection:this.applicationCollection})),t("#qunit-fixture").append(i.$el),equal(t(".app-role-defaults-web-panels").html(),"fusion <b>awesome</b> content")}),test("Dialog should trigger showContents event on showContents",function(){var e=o.call(this),t=this.createDialogViewAndRenderIt(this.applicationCollection);t.dialog={showContents:sinon.spy()};var i=sinon.spy();t.on("showContents",i),t.showContents(new e({collection:this.applicationCollection})),ok(i.called)})})}),AJS.test.require(["jira.webresources:application-roles"],function(){"use strict";require(["backbone","jquery","wrm/data"],function(e,t,i){module("Defaults init tests",{setup:function(){this.context=AJS.test.mockableModuleContext(),this.dialogTrigger=t("<a href='#' class='app-role-defaults-show-button'>Dialog trigger</a>"),t("#qunit-fixture").append(this.dialogTrigger)},teardown:function(){},initDialog:function(){var i={};this.context.mock("jira/admin/application/defaults/DialogView",e.View.extend({initialize:function(){i.currentDialog=this},show:function(){},disable:function(){}}));var o=this.context.require("jira/admin/application/defaults");return i.defaults=new o({whenFetched:function(){return(new t.Deferred).promise()}}),i}}),test("Init should use provided webpanels to init pluginpoint",function(){var e=sinon.stub(i,"claim");e.withArgs("com.atlassian.jira.web.action.admin.application-access:defapp-selector-webpanels").returns("web-panels-content");var t=this.initDialog();this.dialogTrigger.click(),equal(t.currentDialog.options.webPanels,"web-panels-content"),e.restore()}),test("Should emit API event on dialog show event",function(){var e=require("jira/admin/application/defaults/api");this.context.mock("jira/admin/application/defaults/api",e);var t=this.initDialog(),i=sinon.spy();e.on(e.EVENT_ON_SHOW,i),this.dialogTrigger.click(),t.currentDialog.trigger("showContents"),ok(i.called)})})});