define("jira/project/permissions/permissionschemeview",["jira/util/formatter","backbone","underscore","internal/browser-metrics","jira/project/permissions/permissiongroupview","jira/project/permissions/addpermissionmodel","jira/project/permissions/addpermissionview","jira/project/permissions/deletepermissionview","jira/flag"],function(e,s,i,t,r,o,n,a,d){"use strict";var l={ADD_PERMISSION_DIALOG_OPEN:"jira.dialog.open.add-permission-dialog",DELETE_PERMISSION_DIALOG_OPEN:"jira.dialog.open.delete-permission-dialog"};return s.View.extend({tagName:"div",template:JIRA.Templates.ProjectPermissions.permissionScheme,events:{"click .js-grant-permission-trigger":"openAddDialog"},addDialogSelector:"#grant-project-permission-popup",deleteDialogSelector:"#delete-permission-dialog",initialize:function(e){this.sharedProjects=e.sharedProjects||[],this.listenTo(this.model,"change",this.render)},render:function(){this.$el.html(this.template({id:this.model.get("id"),name:this.model.get("name"),description:this.model.get("description"),sharedProjects:this.sharedProjects}));var e=this,s=e.model.get("displayRendering").grouping,t=e.model.isReadOnly();return i.each(s,function(s){var i=e.model.getGroupModel(s),o=new r({model:i,readOnly:t});e.$el.append(o.render().el),o.on({openAddDialog:e.openAddPermissionView,openDeleteDialog:e.openDeletePermissionView},e)}),this.trigger("renderDone",this.$el),this},openAddDialog:function(e){e.preventDefault(),this.openAddPermissionView()},openAddPermissionView:function(e){t.start({key:l.ADD_PERMISSION_DIALOG_OPEN,isInital:!1,threshold:500}),this.$el.append(JIRA.Templates.AddProjectPermission.renderPopupContent());var s=new o({permissionSchemeId:this.model.get("id"),permissionKey:e});this._addView=new n({el:this.addDialogSelector,schemeModel:this.model,model:s}),this._addView.on("permissionGranted",this.displayOperationSuccessMessage,this),this._addView.on("grantPermissionError",this.displayOperationFailureMessage,this),this._addView.once("contentLoaded",function(){t.end({key:l.ADD_PERMISSION_DIALOG_OPEN})}),this._addView.open(),s.fetch()},openDeletePermissionView:function(e){this.$el.append(JIRA.Templates.ProjectPermissions.deleteDialog({permissionName:e.get("permissionName")})),t.start({key:l.DELETE_PERMISSION_DIALOG_OPEN,isInital:!1,threshold:500}),this._deleteView=new a({el:this.deleteDialogSelector,model:e,permissionSchemeId:this.model.get("id")}),this._deleteView.on("deleteCompleted",this.displayOperationSuccessMessage,this),this._deleteView.on("deletePermissionError",this.displayOperationFailureMessage,this),this._deleteView.once("contentLoaded",function(){t.end({key:l.DELETE_PERMISSION_DIALOG_OPEN})}),this._deleteView.open()},displayOperationSuccessMessage:function(e){this.model.set(this.model.parse(e));var s;switch(e.operationResult.type){case"success":s=d.showSuccessMsg;break;case"info":s=d.showInfoMsg;break;default:return}s("",i.first(e.operationResult.messages),{close:"auto"})},displayOperationFailureMessage:function(s){var i=this._extractErrorMessages(s);if(i.length>0){var t=e.I18n.getText("admin.permissions.feedback.feedbackerror.title.single"),r=JIRA.Templates.ProjectPermissions.renderMessageList({messages:i});i.length>1&&(t=e.I18n.getText("admin.permissions.feedback.feedbackerror.title.multiple"),r=e.I18n.getText("admin.permissions.feedback.feedbackerror.desc")+r),d.showWarningMsg(t,r,{close:"manual"})}else d.showWarningMsg(e.I18n.getText("admin.permissions.feedback.unspecifiederror.title"),e.I18n.getText("admin.permissions.feedback.unspecifiederror.description"),{close:"manual"})},_extractErrorMessages:function(e){var s=[];return!1===i.isObject(e)?s:(!0===i.isArray(e.errorMessages)&&e.errorMessages.length>0&&s.push.apply(s,i.clone(e.errorMessages)),!0===i.isObject(e.errors)&&s.push.apply(s,i.collect(e.errors,function(e){return e})),s)}})});