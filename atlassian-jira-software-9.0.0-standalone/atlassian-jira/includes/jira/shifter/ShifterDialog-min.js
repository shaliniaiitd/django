define("jira/shifter/shifter-dialog",["jira/util/key-code","jira/jquery/deferred","jira/lib/class","jira/data/session-storage","jira/shifter/shifter-select","jira/ajs/list/group-descriptor","jira/ajs/list/item-descriptor-factory","jira/shifter/shifter-analytics","jquery","underscore"],function(t,i,e,n,s,o,r,a,d,u){"use strict";return e.extend({BLUR_DELAY:50,init:function(t,i,e){this.id=t,this.groups=i,this.options=e,this._render(),this._destroyOnBlur(),this._preventFocusOnNonInputElements(),d(document).on("mousedown.shifterdialog."+t,u.bind(this._destroyOnMousedownOutside,this))},focus:function(){this.$dialog&&this.$dialog.find("input").focus()},destroy:function(){var t=this.$dialog;t&&(t.stop().animate({top:-1*t.height()},100,function(){t.remove()}),this.$dialog=null,d(document).off("mousedown.shifterdialog."+this.id))},destroyed:function(){return!this.$dialog},saveLastQuery:function(t){try{n.setItem("JIRA.Shifter.lastQuery",t)}catch(t){}},getLastQuery:function(){return n.getItem("JIRA.Shifter.lastQuery")},enterLoadingState:function(){var t=this.$dialog;t.addClass("loading-action"),t.find(".aui-list").slideUp(200)},_render:function(){var i=JIRA.Templates.Shifter.dialog({id:this.id}),e=this.$dialog=d(i).appendTo("body"),n=this.shifterSelect=new s({id:this.id,element:e.find(".aui-list"),groups:this.groups,suggestionsHandler:this._makeSuggestionsHandler(),onSelection:u.bind(this._onSelection,this),maxResultsDisplayedPerGroup:this.options.maxResultsDisplayedPerGroup});this.getLastQuery()&&(n.$field.val(this.getLastQuery()).select(),n.onEdit()),n.$field.on("keyup",u.bind(function(i){i.which===t.ESCAPE&&(i.stopPropagation(),this.destroy())},this)),AJS.currentLayerItem&&AJS.currentLayerItem.hide&&AJS.currentLayerItem.hide(),this._closeDropdownsIfNeeded(),e.css("top",-1*e.height()).animate({top:0},100)},_closeDropdownsIfNeeded:function(){d(".aui-dropdown2-trigger.aui-dropdown2-active").trigger("aui-button-invoke")},_destroyOnBlur:function(){this.$dialog.find("input").blur(u.bind(function(){setTimeout(u.bind(function(){this.$dialog&&!d.contains(this.$dialog[0],document.activeElement)&&this.destroy()},this),this.BLUR_DELAY)},this))},_destroyOnMousedownOutside:function(t){0===this.$dialog.find(t.target).length&&t.target!==this.$dialog&&this.destroy()},_preventFocusOnNonInputElements:function(){var t=this.$dialog.find("input");this.$dialog.mousedown(function(i){-1===d.inArray(i.target,t)&&i.preventDefault()})},_makeSuggestionsHandler:function(){var t=this.groups;return e.extend({execute:function(e){var n=[],s=i(),a=t.length;return u.map(t,function(t,i){return t.getSuggestions(e).done(function(e){u.isArray(e)&&(n.push(new o({label:t.name,description:t.context,weight:t.weight,items:u.map(e,function(t){return r.createItemDescriptor(t,i)})})),n.sort(function(t,i){return t.weight()-i.weight()}))}).always(function(){0===--a&&s.resolve(n,e)})}),s}})},_onSelection:function(t,i,e){a.selection(e,i,t.id),this.saveLastQuery(e);var n=t.onSelection(i,e);n&&u.isFunction(n.always)?(this.enterLoadingState(),n.always(u.bind(this.destroy,this))):this.destroy()}})}),AJS.namespace("JIRA.ShifterComponent.ShifterDialog",null,require("jira/shifter/shifter-dialog"));