AJS.test.require(["jira.webresources:list"],function(){"use strict";require(["jira/ajs/list/list","jira/ajs/list/item-descriptor","jquery","underscore"],function(t,e,i,l){module("AJS.List",{buildList:function(s,n){n||(n=i("#qunit-fixture"));var a={containerSelector:n,delegateTarget:n,stallEventBind:!1,expandAllResults:!0};this.options=i.extend(!0,a,s);var u={},r=[];return{withMaxResultsDisplayed:function(t){return u.maxInlineResultsDisplayed=t,this},withExpandAllResults:function(t){return u.expandAllResults=t,this},withTotalResults:function(t){return r.push(function(i){for(var l=[],s=0;s<t;s++)l.push(new e({highlighted:!0,label:"Label #"+s,title:"Title #"+s}));i.generateListFromJSON(l,"Label")}),this},withData:function(t){return r.push(function(e){e.generateListFromJSON(t,"Label")}),this},withEventsEnabled:function(){return r.push(function(t){t.enable()}),this},withScrollAtItem:function(t){return r.push(function(){var e=i.Event("keydown");e.which=i.ui.keyCode.DOWN;for(var l=0;l<t;l++)n.trigger(e)}),this},withLoopThroughOptions:function(){return u.loopThroughOptions=!0,this},build:function(){var e=new t(l.defaults(u,a));return l.each(r,function(t){t(e)}),e}}},pressDownArrowOn:function(t){var e=i.Event("keydown");e.which=i.ui.keyCode.DOWN,t.trigger(e)}}),test("List should use title from AJS.ItemDescriptor",function(){var t=[new e({label:"Label with title",title:"some tile"}),new e({label:"Label without title"}),new e({label:"Label with empty tile",title:""})];this.buildList().withData(t).build();var l=i("#qunit-fixture").find(".aui-list-item-link");equal(l.length,3,"There should be three links rendered"),equal(i(l.get(0)).prop("title"),t[0].title(),"Link have valid title"),equal(i(l.get(0)).text(),t[0].label(),"Link have valid text"),equal(i(l.get(1)).text(),t[1].label(),"Link have valid text"),equal(i(l.get(2)).text(),t[2].label(),"Link have valid text")}),test("List should use passed in HTML tag for items",function(){var t=[new e({label:"Label with title",title:"some tile"})];this.buildList({listItemTag:"span"}).withData(t).build();var l=i("#qunit-fixture").find(".aui-list-item-link");equal(l.length,1,"There should be one link rendered"),equal(i(l.get(0)).prop("tagName"),"SPAN","Passed tag is used for links"),equal(i(l.get(0)).attr("role"),"presentation","Items have valid roles"),equal(i(l.get(0)).attr("class"),"aui-list-item-link","Items have valid class")}),test("List should use anchor for items if no HTML tag was passed as option",function(){var t=[new e({label:"Label with title",title:"some tile"})];this.buildList().withData(t).build();var l=i("#qunit-fixture").find(".aui-list-item-link");equal(l.length,1,"There should be one link rendered"),equal(i(l.get(0)).prop("tagName"),"A","Anchor is a default tag for links"),equal(i(l.get(0)).attr("role"),"presentation","Items have valid roles"),equal(i(l.get(0)).attr("class"),"aui-list-item-link","Items have valid class")}),test("List should prepend passed prefix to subtext",function(){var t=[new e({label:"main text",keywords:"subtext Label"})];this.buildList({subtextPrefix:" £@! some prefix -"}).withData(t).build();var l=i("#qunit-fixture .aui-item-text"),s=i("#qunit-fixture .aui-item-suffix");equal(i(l.get(0)).text(),"main text","Main text is set correctly"),equal(i(s.get(0)).text()," £@! some prefix - subtext Label","Subtext is prepended with passed prefix")}),test("Protect against XSS vulnerability injected in descriptor icon",function(){var t={xssCall:function(){}};sinon.mock(t).expects("xssCall").never(),window.xssCall=t.xssCall;var e=[new AJS.ItemDescriptor({label:"Label with title",title:"some tile",icon:function(){return'genericissue.png"><script>window.xssCall()<\/script>'}})];this.buildList().withData(e).build(),window.xssCall=null,expect(0)}),test("It limits the number of results displayed",function(){this.buildList().withMaxResultsDisplayed(10).withTotalResults(20).build();var t=i("#qunit-fixture");equal(t.find(".aui-list-item-link").length,10,"Only 10 links are rendered")}),test("It displays a 'View more' link when there is too many results if expandAllResults is true",function(){this.buildList().withMaxResultsDisplayed(10).withExpandAllResults(!0).withTotalResults(20).build();var t=i("#qunit-fixture");equal(t.find("button.view-all").length,1,"There is one 'view-all' button")}),test("It does not display a 'View more' link when there is too many results if expandAllResults is false",function(){this.buildList().withMaxResultsDisplayed(10).withExpandAllResults(!1).withTotalResults(20).build();var t=i("#qunit-fixture");equal(t.find("button.view-all").length,0,"There is not 'view-all' button")}),test("'View more' expand the list so it contains all the results",function(){this.buildList().withMaxResultsDisplayed(10).withTotalResults(20).build();var t=i("#qunit-fixture");t.find("button.view-all").click(),equal(t.find(".aui-list-item-link").length,20,"All the results are rendered")}),test("In a limited list, scrolling down using arrow keys expand all the list when reaching the last item if expandAllResults is true",function(){this.buildList().withMaxResultsDisplayed(3).withTotalResults(6).withEventsEnabled().withScrollAtItem(2).build();var t=i("#qunit-fixture");this.pressDownArrowOn(t),equal(t.find(".aui-list-item-link").length,6,"All the results are rendered"),equal(t.find("button.view-all").length,0,"The 'view-all' link is removed")}),test("In a limited list, scrolling down using arrow keys does not expand the list when reaching the last item if expandAllResults is false",function(){this.buildList().withMaxResultsDisplayed(3).withTotalResults(6).withExpandAllResults(!1).withEventsEnabled().withScrollAtItem(2).build();var t=i("#qunit-fixture");this.pressDownArrowOn(t),equal(t.find(".aui-list-item-link").length,3,"Three links are rendered")}),test("It triggers an event when item is active/focused.",function(){var t=this.buildList().withMaxResultsDisplayed(3).withTotalResults(6).withExpandAllResults(!1).withLoopThroughOptions().withEventsEnabled().withScrollAtItem(2).build(),e=sinon.spy();t.bind("itemFocus",e);var l=i("#qunit-fixture");this.pressDownArrowOn(l),this.pressDownArrowOn(l),sinon.assert.calledTwice(e),equal(e.secondCall.args[1],t.getFocused()[0],"Correct item is passed as an argument.")}),test("Stops at the last element by default",function(){this.buildList().withEventsEnabled().withMaxResultsDisplayed(3).withTotalResults(3).withExpandAllResults(!1).withScrollAtItem(2).build();var t=i("#qunit-fixture");this.pressDownArrowOn(t),ok(t.find("ul li:last-child").hasClass("active"))}),test("Cycles back from the top when configured",function(){this.buildList().withEventsEnabled().withMaxResultsDisplayed(3).withTotalResults(3).withExpandAllResults(!1).withScrollAtItem(2).withLoopThroughOptions().build();var t=i("#qunit-fixture");this.pressDownArrowOn(t),ok(t.find("ul li:first-child").hasClass("active"))}),test("Adds title attrs to project items",function(){document.getElementById("qunit-fixture").innerHTML='<div id="project-suggestions" />';var t=document.getElementById("project-suggestions"),l=[new e({label:"Label without title"}),new e({label:"Label with title",title:"AAA"})];this.buildList({listItemTag:"a"},i(t)).withData(l).build();var s=t.getElementsByClassName("aui-list-item-link");equal(s.length,2,"There should be 2 links rendered"),equal(s[0].getAttribute("title"),"Label without title","Title (unset in data) is the same as label"),equal(s[1].getAttribute("title"),"AAA","Title (set in data) is unchanged"),t.parentNode.removeChild(t)}),test("Does not add title attrs to project items ($container is not project-suggestions)",function(){var t=document.getElementById("qunit-fixture"),i=[new e({label:"Label without title"}),new e({label:"Label with title",title:"AAA"})];this.buildList({listItemTag:"a"}).withData(i).build();var l=t.getElementsByClassName("aui-list-item-link");equal(l.length,2,"There should be 2 links rendered"),equal(l[0].getAttribute("title"),void 0,"Title (unset in data) is still unset"),equal(l[1].getAttribute("title"),"AAA","Title (set in data) is unchanged")})})});