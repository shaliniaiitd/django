define("jira/customfields/customfieldsFilterView",["atlassian/libs/underscore-1.8.3","jira/marionette-4.1","jira/analytics","jira/featureflags/feature-manager","jira/util/formatter","jira/customfields/customfieldsFilterDropdownView","jira/customfields/customfieldsSelectDropdownView","jira/customfields/customfieldsFilterProjectCollection","jira/customfields/customfieldsFilterTypesCollection","jira/customfields/customfieldsFilterScreensCollection","jira/customfields/customfieldsSelectLastValueUpdateCollection"],function(e,t,i,s,r,o,l,n,c,a,d){"use strict";var p=s.isFeatureEnabled("jira.customfields.cleanup.identification");return t.View.extend({template:JIRA.Templates.Admin.Customfields.filterContainer,templateContext:{showLastValueUpdateFilter:p},ui:{searchInput:"#custom-fields-filter-text",projectsTrigger:"#projects-dropdown-trigger",typesTrigger:"#types-dropdown-trigger",screensTrigger:"#screens-dropdown-trigger",lastValueUpdateTrigger:"#last-value-update-dropdown-trigger",projectsDropdown:"#projects-filter-dropdown",typesDropdown:"#types-filter-dropdown",screensDropdown:"#screens-filter-dropdown",lastValueUpdateDropdown:"#last-value-update-filter-dropdown",container:".customfield-filter-items"},regions:function(){var e={screens:{el:"#screens-filter-dropdown",replaceElement:!0},types:{el:"#types-filter-dropdown",replaceElement:!0},projects:{el:"#projects-filter-dropdown",replaceElement:!0}};return p&&(e.lastValueUpdate={el:"#last-value-update-filter-dropdown",replaceElement:!0}),e},events:{"input @ui.searchInput":"performTextSearch","aui-dropdown2-show @ui.projectsDropdown":function(){this.projectsDropdownView.reorderItems(),this.projectsDropdownView.focusField()},"aui-dropdown2-show @ui.typesDropdown":function(){this.typesDropdownView.reorderItems(),this.typesDropdownView.focusField()},"aui-dropdown2-show @ui.screensDropdown":function(){this.screensDropdownView.reorderItems(),this.screensDropdownView.focusField()}},childViewEvents:{"filter:changed":"onChildviewFilterChanged","filter:cleared":"onChildviewFilterCleared","option:selected":"onChildviewOptionSelected"},initialize:function(){this.projectFilterCollection=new n,this.typesFilterCollection=new c,this.screensFilterCollection=new a,this.lastValueUpdateCollection=new d,this.projectsDropdownView=new o({collection:this.projectFilterCollection,id:"projects-filter-dropdown",customfieldCollection:this.collection}),this.typesDropdownView=new o({collection:this.typesFilterCollection,id:"types-filter-dropdown",customfieldCollection:this.collection}),this.screensDropdownView=new o({collection:this.screensFilterCollection,id:"screens-filter-dropdown",customfieldCollection:this.collection}),p&&(this.lastValueUpdateDropdownView=new l({collection:this.lastValueUpdateCollection,id:"last-value-update-filter-dropdown"}))},onRender:function(){this.unwrapTemplate(),this.showChildView("projects",this.projectsDropdownView),this.showChildView("types",this.typesDropdownView),this.showChildView("screens",this.screensDropdownView),p&&this.showChildView("lastValueUpdate",this.lastValueUpdateDropdownView),this.setButtonsText(this.projectFilterCollection),this.setButtonsText(this.screensFilterCollection),this.setButtonsText(this.typesFilterCollection),p&&this.setButtonsText(this.lastValueUpdateCollection,!0)},onChildviewFilterChanged:function(t){var i=t.model.collection,s=i.id,r=t.getUI("filter"),o=r.val(),l=r.prop("checked"),n=this.collection.filters[s];l&&!e.contains(n,o)?n.push(o):!l&&e.contains(n,o)&&n.splice(n.indexOf(o),1),this.sendAnalyticsFilterEvent(s,n),this.setButtonsText(i),this.performSearch()},onChildviewOptionSelected:function(e){var t=e.model.collection,i=t.id;this.collection.filters[i]=e.model.get("value"),this.sendAnalyticsFilterEvent(i,[e.model.get("value")]),this.setButtonsText(e.model.collection,!0),this.performSearch()},onChildviewFilterCleared:function(e){this.setButtonsText(e),this.performSearch()},performSearch:function(){var e=this;this.triggerMethod("search:start"),this.collection.getFirstPage({reset:!0}).always(function(){e.triggerMethod("search:end")}).fail(function(t){return e.triggerMethod("navigate:error",t)})},performTextSearch:e.debounce(function(){var e=this,t=this.getUI("searchInput"),i=t.val();i!==this.currentInputValue&&(this.triggerMethod("search:start"),t.blur(),this.currentInputValue=i,this.collection.searchTerm=i,this.collection.getFirstPage({reset:!0}).always(function(){t.focus(),e.triggerMethod("search:end")}).fail(function(t){return e.triggerMethod("navigate:error",t)}))},500),currentInputValue:"",sendAnalyticsFilterEvent:function(e,t){var s=e;switch(e){case"projectIds":s="projects";break;case"types":s="types";break;case"screenIds":s="screens";break;case"lastValueUpdate":s="lastvalueupdate"}i.send({name:"admin.customfields.filter."+s,properties:{values:t||[]}})},setButtonsText:function(e,t){var i=e.id,s=e.name,r=this.getUI(s+"Trigger"),o=this.collection.filters[i]||[];if(!o||Array.isArray(o)&&0===o.length)return r.text(this._getDefaultButtonText(s));var l=t?this._getFilterTitle(s)+": ":"";return r.text(l+this._getAppliedFilterNames(s,o))},_getFilterTitle:function(e){var t=void 0;switch(e){case"projects":t=r.I18n.getText("common.words.project");break;case"screens":t=r.I18n.getText("admin.common.words.screen");break;case"types":t=r.I18n.getText("admin.common.words.type");break;case"lastValueUpdate":t=r.I18n.getText("admin.issuefields.last.value.update")}return t},_getDefaultButtonText:function(e){return this._getFilterTitle(e)+": "+r.I18n.getText("common.words.all")},_getAppliedFilterNames:function(t,i){var s=void 0;switch(t){case"projects":s=this.projectFilterCollection;break;case"screens":s=this.screensFilterCollection;break;case"types":s=this.typesFilterCollection;break;case"lastValueUpdate":s=this.lastValueUpdateCollection}return Array.isArray(i)?s.reduce(function(t,s){return e.contains(i,s.id.toString())&&s.get("name").length>0&&t.push(s.get("name")),t},[]).join(", "):s.find({value:i}).get("name")}})});