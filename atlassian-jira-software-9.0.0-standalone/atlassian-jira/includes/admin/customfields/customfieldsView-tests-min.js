AJS.test.require(["jira.webresources:viewcustomfields"],function(){"use strict";var e=require("underscore"),s=require("jquery"),t=require("jira/customfields/customfieldsView"),i=require("jira/customfields/customfieldsCollection"),o=require("jira/featureflags/feature-manager"),n=require("jira/message"),r=(new i).state.pageSize;module("CustomfieldsPageView",{setup:function(){this.context=AJS.test.mockableModuleContext(),this.sandbox=sinon.sandbox.create({useFakeServer:!0}),this.customFields=[{name:"CF 1",type:"Number Field",contextSchemesCount:1,screensCount:1},{name:"CF 2",type:"Magic Field",searcherKey:"nosearcher",contextSchemesCount:10,screensCount:0}],this.sandbox.stub(o,"isFeatureEnabled",function(e){return!!["jira.customfields.cleanup.identification","jira.customfields.bulk.delete"].includes(e)}),this.sandbox.stub(n,"showSuccessMsg"),this.sandbox.stub(n,"showErrorMsg"),s("#qunit-fixture").html('<section id="customfields-container"> </section>'),this.mockCustomfieldsResponse(),this.customfieldsPageView=new t({el:"#customfields-container"})},teardown:function(){this.sandbox.restore()},mockCustomfieldsResponse:function(){this.sandbox.server.respondWith([200,{"Content-Type":"application/json"},JSON.stringify({maxResults:r,startAt:0,total:this.customFields.length,isLast:!0,values:this.customFields.map(function(s,t){return e.extend({id:"customfield_"+(1e4+t),self:"http://localhost:8090/jira/rest/api/2/customFields/customfield_"+(1e4+t),numericId:1e4+t,isLocked:!1,isManaged:!1,isTrusted:0===t,issuesWithValue:t+1,searcherKey:"asdsda"},s)})})])}}),test("Custom fields list is rendered",function(){this.sandbox.server.respond();var t=s("#qunit-fixture #custom-fields-table tbody"),i=t.find("tr td:first-child+td strong").map(function(e,s){return s.innerHTML}).get(),o=t.find("tr>td:first-child+td+td>span").map(function(e,s){return s.innerHTML}).get();deepEqual(i,e.pluck(this.customFields,"name"),"Names are rendered"),deepEqual(o,e.pluck(this.customFields,"type"),"Types are rendered")}),test("Displays progress indicator on load",function(){var e=s("#qunit-fixture #customfields-container");ok(e.hasClass("active"),"has progress indicator overlay"),ok(e.has("aui-spinner.customfields-spinner").length,"has aui spinner"),this.sandbox.server.respond(),notOk(e.hasClass("active"),"has no progress indicator overlay after data is loaded"),notOk(e.has("aui-spinner.customfields-spinner").length,"hides aui spinner after data is loaded")}),test("Displays progress indicator on sort",function(){this.sandbox.server.respond();var e=s("#qunit-fixture #customfields-container");e.find('th[data-sort-key="lastValueUpdate"]').trigger("click"),ok(e.hasClass("active"),"has progress indicator overlay"),ok(e.has("aui-spinner.customfields-spinner").length,"has aui spinner"),this.sandbox.server.respond(),notOk(e.hasClass("active"),"has no progress indicator overlay after data is loaded"),notOk(e.has("aui-spinner.customfields-spinner").length,"hides aui spinner after data is loaded")}),asyncTest("Displays progress indicator on search",function(){var e=this;this.sandbox.server.respond(),this.sandbox.server.respondWith([200,{"Content-Type":"application/json"},JSON.stringify([])]),this.sandbox.server.respond();var t=s("#qunit-fixture #customfields-container");t.find("#custom-fields-filter-text").val("blah").trigger("input"),setTimeout(function(){ok(t.hasClass("active"),"has progress indicator overlay"),ok(t.has("aui-spinner").length,"has aui spinner"),e.sandbox.server.respond(),notOk(t.hasClass("active"),"has no progress indicator overlay after data is loaded"),notOk(t.has("aui-spinner.customfields-spinner").length,"hides aui spinner after data is loaded"),start()},1e3)}),asyncTest("Displays empty search results view on empty search",function(){var e=this;this.sandbox.server.respond(),this.sandbox.server.respondWith([200,{"Content-Type":"application/json"},JSON.stringify([])]),this.sandbox.server.respond();var t=s("#qunit-fixture #customfields-container");t.find("#custom-fields-filter-text").val("blah").trigger("input"),setTimeout(function(){e.sandbox.server.respondWith([200,{"Content-Type":"application/json"},JSON.stringify({maxResults:r,startAt:0,total:0,isLast:!0,values:[]})]),e.sandbox.server.respond();var i=s("#qunit-fixture #custom-fields-table tbody tr");ok(i.length,"only one row for empty result message is rendered"),ok(i.find(".jira-adbox.no-project-results").length,"empty view is displayed"),notOk(t.hasClass("active"),"has no progress indicator overlay on empty screen"),notOk(t.has("aui-spinner.customfields-spinner").length,"hides aui spinner after displaying empty screen"),start()},1e3)}),asyncTest("Displays error flag on search failure",function(){var e=this;s("#aui-flag-container").remove(),this.sandbox.server.respond();var t=s("#qunit-fixture #customfields-container");t.find("#custom-fields-filter-text").val("blah").trigger("input"),setTimeout(function(){e.sandbox.server.respondWith([404,{},""]),e.sandbox.server.respond(),ok(n.showErrorMsg.lastCall.calledWith(sinon.match("rest.error.internal")),"error message is correct"),notOk(t.hasClass("active"),"has no progress indicator overlay after search failure"),notOk(t.has("aui-spinner.customfields-spinner").length,"hides aui spinner after search failure"),start()},1e3)}),test("Displays error flag on sort failure",function(){s("#aui-flag-container").remove(),this.sandbox.server.respond();var e=s("#qunit-fixture #customfields-container");e.find('th[data-sort-key="issuesWithValue"]').trigger("click"),this.sandbox.server.respondWith([500,{},""]),this.sandbox.server.respond(),ok(n.showErrorMsg.lastCall.calledWith(sinon.match("rest.error.internal")),"error message is correct"),notOk(e.hasClass("active"),"has no progress indicator overlay after sort failure"),notOk(e.has("aui-spinner.customfields-spinner").length,"hides aui spinner after sort failure")}),test("Projects link is correctly displayed",function(){this.customFields=[{name:"CF 3",type:"Number Field",isAllProjects:!0,projectsCount:0,screensCount:1},{name:"CF 4",type:"Number Field",isAllProjects:!1,projectsCount:0,screensCount:1},{name:"CF 5",type:"Test Field",searcherKey:"nosearcher",isAllProjects:!1,projectsCount:10,screensCount:3}],this.mockCustomfieldsResponse(),this.sandbox.server.respond();var e=s("#qunit-fixture #customfields-container #custom-fields-table tbody");equal(e.find("tr:first td:eq(3)").text(),"admin.issuefields.customfields.global.all.projects","displays global projects read onlytext"),equal(e.find("tr:eq(1) td:eq(3)").text(),"admin.issuefields.customfields.projects.conditional","displays 0 projects read only text"),notOk(e.find("tr:eq(1) td:eq(3)").has("a").length,"0 projects text is read only"),equal(e.find("tr:eq(2) td:eq(3)").text(),"admin.issuefields.customfields.projects.conditional","displays n projects text"),ok(e.find("tr:eq(2) td:eq(3)").has("a").length,"n projects text is clickable link")}),asyncTest("Focus on search input field should not cause search execution (IE11)",function(){var e=this;this.sandbox.server.respond();var t=s("#qunit-fixture #customfields-container"),i=t.find("#custom-fields-filter-text");this.customfieldsPageView.collection.getFirstPage=this.sandbox.spy(),i.focus().trigger("focus"),setTimeout(function(){notOk(t.hasClass("active"),"doesn't have progress indicator overlay"),notOk(t.has("aui-spinner.customfields-spinner").length,"doesn't have aui spinner"),sinon.assert.notCalled(e.customfieldsPageView.collection.getFirstPage),start()},1e3)}),test("DC - Custom fields list can be sorted and resetted",function(){this.sandbox.server.respond();var e=s("#qunit-fixture #customfields-container");equal(e.find('th[data-sort-key="issuesWithValue"]').data("sort-order"),"","No initial sorting"),e.find('th[data-sort-key="issuesWithValue"]').trigger("click"),this.sandbox.server.respond(),equal(e.find('th[data-sort-key="issuesWithValue"]').data("sort-order"),"ascending","Sorts ascending"),e.find('th[data-sort-key="issuesWithValue"]').trigger("click"),this.sandbox.server.respond(),equal(e.find('th[data-sort-key="issuesWithValue"]').data("sort-order"),"descending","Sorts descending"),e.find('th[data-sort-key="issuesWithValue"]').trigger("click"),this.sandbox.server.respond(),equal(e.find('th[data-sort-key="issuesWithValue"]').data("sort-order"),"","Sort is resetted")}),test("DC - Custom fields usage data is displayed for trusted and untrusted fields",function(){var t=s("#qunit-fixture #customfields-container");this.sandbox.server.respondWith([200,{"Content-Type":"application/json"},JSON.stringify({maxResults:r,startAt:0,total:this.customFields.length,isLast:!0,values:this.customFields.map(function(s,t){return e.extend({id:"customfield_"+(1e4+t),self:"http://localhost:8090/jira/rest/api/2/customFields/customfield_"+(1e4+t),numericId:1e4+t,isLocked:!1,isTrusted:0===t,isManaged:!1,searcherKey:"asdsda"},s)})})]),this.sandbox.server.respond(),notOk(t.find("tr[data-custom-field-id]:eq(0) .customfield-help-icon").length,"hides untrusted field icon"),ok(t.find("tr[data-custom-field-id]:eq(1) .customfield-help-icon").length,"shows untrusted field icon"),equal(t.find("tr[data-custom-field-id]:eq(0) td:eq(6)").text(),"0","trusted field displays zero"),equal(t.find("tr[data-custom-field-id]:eq(1) td:eq(6)").text(),"admin.issuefields.customfields.no.data","untrusted field displays copy text"),equal(t.find("tr[data-custom-field-id]:eq(0) td:eq(5)").text(),"admin.common.words.never",'trusted field displays correct "no usage" copy'),equal(t.find("tr[data-custom-field-id]:eq(1) td:eq(5)").text(),"admin.issuefields.customfields.no.data",'untrusted field displays correct "no usage" copy'),this.mockCustomfieldsResponse(),t.find('th[data-sort-key="issuesWithValue"]').trigger("click"),this.sandbox.server.respond(),equal(t.find("tr[data-custom-field-id]:eq(0) td:eq(6)").text(),"1","trusted field displays positive issues count"),equal(t.find("tr[data-custom-field-id]:eq(1) td:eq(6)").text(),"2","untrusted field displays positive issues count")}),test("DC - Single custom field can be deleted",function(){this.mockCustomfieldsResponse(),this.sandbox.server.respond();var e=s("#qunit-fixture #customfields-container");e.find("table .aui-dropdown2-trigger").eq(0).trigger("click"),e.find(".customfield-delete-trigger").eq(0).trigger("click"),ok(s("#customfield-delete-dialog[open]").length,"dialog is open");var t=s("#customfield-delete-dialog .customfield-delete-dialog-submit"),i=s("#customfield-delete-dialog .customfield-delete-dialog-spinner");t.click(),ok(t.prop("disabled"),"submit button is disabled"),notOk(i.hasClass("hidden"),"spinner is visible"),this.sandbox.server.respondWith([500,{},JSON.stringify({deletedCustomFields:[],notDeletedCustomFields:["customfield_10000"]})]),this.sandbox.server.respond(),ok(n.showErrorMsg.lastCall.calledWith(sinon.match("rest.error.internal")),"error message is correct"),e.find("table .aui-dropdown2-trigger").eq(0).trigger("click"),e.find(".customfield-delete-trigger").eq(0).trigger("click"),t.click(),this.sandbox.server.respondWith([200,{"Content-Type":"application/json"},JSON.stringify({deletedCustomFields:["customfield_10000"],notDeletedCustomFields:[]})]),this.sandbox.server.respond(),notOk(t.prop("disabled"),"submit button is enabled"),ok(i.hasClass("hidden"),"spinner is hidden"),notOk(s("#customfield-delete-dialog[open]").length,"dialog is hidden"),ok(n.showSuccessMsg.lastCall.calledWith("admin.issuefields.customfields.delete.single.success"),"success message is correct")}),test("DC - Bulk selection works properly",function(){function t(e){return l.find("tr[data-custom-field-id]:eq("+e+") td:eq(0) input[type=checkbox]")}function i(){return l.find(".custom-fields-bulk-checkbox")}function o(){return l.find(".custom-fields-bulk-delete")}function n(){return s("#customfield-delete-dialog .customfield-delete-dialog-cancel")}function d(){return s("#customfield-delete-dialog .customfield-delete-dialog-content")}var a=[{isLocked:!0},{isManaged:!0},{},{isManaged:!1}];this.sandbox.server.respondWith([200,{"Content-Type":"application/json"},JSON.stringify({maxResults:r,startAt:0,total:a.length,isLast:!0,values:a.map(function(s,t){return e.extend({id:"customfield_"+(1e4+t),name:"customfield_"+(1e4+t),screensCount:1,projectsCount:1,self:"http://localhost:8090/jira/rest/api/2/customFields/customfield_"+(1e4+t),numericId:1e4+t,searcherKey:t,isTrusted:!s.isManaged&&!s.isLocked},s)})})]),this.sandbox.server.respond();var l=s("#qunit-fixture #customfields-container");ok(t(0).prop("disabled"),"Locked custom field is unselectable"),ok(t(1).prop("disabled"),"Managed custom field is unselectable"),notOk(t(2).prop("disabled"),"Not managed or locked CF is selectable"),i().trigger("click"),equal(l.find("tbody input:checked").length,2,"Bulk checkbox selects all valid inputs"),i().trigger("click"),equal(l.find("tbody input:checked").length,0,"Bulk checkbox unselects all inputs"),t(2).trigger("click"),ok(l.find(".customfields-bulk-delete-meta").text().includes("admin.issuefields.customfields.bulk.select.single"),"Sets single delete copy"),t(3).trigger("click"),ok(l.find(".customfields-bulk-delete-meta").text().includes("admin.issuefields.customfields.bulk.select.multiple"),"Sets multiple delete copy"),ok(i().prop("checked"),"After all single checks, global is checked too"),t(3).trigger("click"),notOk(i().prop("checked"),"After all single checks and then one uncheck, global is unchecked too"),i().trigger("click"),o().trigger("click"),ok(s("#customfield-delete-dialog[open]").length,"Delete dialog is open when clicked delete after bulk check"),ok(d().text().includes("admin.issuefields.customfields.delete.bulk.info"),"Delete dialog informs about bulk deletion"),n().trigger("click"),t(2).trigger("click"),o().trigger("click"),ok(s("#customfield-delete-dialog[open]").length,"Delete dialog is open when clicked delete after single check"),ok(d().text().includes("admin.issuefields.customfields.delete.single.info"),"Delete dialog informs about single deletion"),n().trigger("click")}),test("DC - Disables selection when it's not available",function(){var t=[{isLocked:!0},{isManaged:!0}];this.sandbox.server.respondWith([200,{"Content-Type":"application/json"},JSON.stringify({maxResults:r,startAt:0,total:t.length,isLast:!0,values:t.map(function(s,t){return e.extend({id:"customfield_"+(1e4+t),name:"customfield_"+(1e4+t),screensCount:1,projectsCount:1,self:"http://localhost:8090/jira/rest/api/2/customFields/customfield_"+(1e4+t),numericId:1e4+t,searcherKey:t,isTrusted:!s.isManaged&&!s.isLocked},s)})})]),this.sandbox.server.respond();var i=s("#qunit-fixture #customfields-container");notOk(i.find(".custom-fields-bulk-checkbox").prop("checked"),"Given unselectable results, bulk checkbox is not checked"),ok(i.find(".custom-fields-bulk-checkbox").prop("disabled"),"Given unselectable results, bulk checkbox is disabled")}),test("DC - Delete REST endpoint is returning correct error message",function(){this.mockCustomfieldsResponse(),this.sandbox.server.respond();var e=s("#qunit-fixture #customfields-container");e.find(".custom-fields-bulk-checkbox").trigger("click"),e.find(".custom-fields-bulk-delete").trigger("click");var t=s("#customfield-delete-dialog .customfield-delete-dialog-submit");this.sandbox.server.respondWith([400,{},""]),t.click(),this.sandbox.server.respond(),ok(n.showErrorMsg.lastCall.calledWith(sinon.match("admin.issuefields.customfields.delete.error.zero.title")),"400 is supported"),this.sandbox.server.respondWith([423,{},""]),t.click(),this.sandbox.server.respond(),ok(n.showErrorMsg.lastCall.calledWith(sinon.match("admin.issuefields.customfields.delete.error.clusterlock.title")),"423 cluster lock error is supported"),this.sandbox.server.respondWith([500,{},""]),t.click(),this.sandbox.server.respond(),ok(n.showErrorMsg.lastCall.calledWith(sinon.match("rest.error.internal")),"500 internal server error is supported"),this.sandbox.server.respondWith([503,{},""]),t.click(),this.sandbox.server.respond(),ok(n.showErrorMsg.lastCall.calledWith(sinon.match("admin.issuefields.customfields.delete.error.settings")),"503 license/flag check is supported"),this.sandbox.server.respondWith([200,{"Content-Type":"application/json"},JSON.stringify({deletedCustomFields:["customfield_10001","customfield_10002"],notDeletedCustomFields:["customfield_10003"]})]),t.click(),this.sandbox.server.respond(),ok(n.showSuccessMsg.lastCall.calledWith(sinon.match("admin.issuefields.customfields.delete.bulk.success")),"Shows success flag on some successful results"),ok(n.showErrorMsg.lastCall.calledWith(sinon.match("admin.issuefields.customfields.delete.error.some.title")),"Shows error flag on some unsuccessful results")}),module("CustomfieldsPageView - Server",{setup:function(){this.context=AJS.test.mockableModuleContext(),this.sandbox=sinon.sandbox.create({useFakeServer:!0}),this.sandbox.stub(o,"isFeatureEnabled",function(){return!1})}}),test("Feature flag turns new UI off",function(){this.sandbox.server.respondWith(200,{"Content-Type":"application/json"},""),this.sandbox.server.respond();var e=s("#qunit-fixture #customfields-container");notOk(e.find(".custom-fields-bulk-checkbox").length,"Bulk delete is hidden"),notOk(e.find(".customfield-values").length,"Issues column is hidden"),notOk(e.find(".customfield-updates").length,"Updates column is hidden"),notOk(e.find("#last-value-update").length,"Last value update filter is hidden"),notOk(e.find(".customfields-recalculation-details").length,"Recalculation details are hidden")})});