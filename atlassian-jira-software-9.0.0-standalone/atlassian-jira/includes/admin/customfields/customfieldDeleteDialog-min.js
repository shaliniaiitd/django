define("jira/customfields/customfieldDeleteDialog",["jira/marionette-4.1","jira/analytics","jira/message","jira/ajs/ajax/smart-ajax","jira/util/formatter","underscore","wrm/context-path"],function(e,t,i,s,n,l,o){"use strict";var d=o()+"/rest/api/2/customFields";return e.View.extend({template:JIRA.Templates.Admin.Customfields.deleteDialog,model:null,ui:{submitButton:".customfield-delete-dialog-submit",cancelButton:".customfield-delete-dialog-cancel",closeButton:".aui-close-button",spinner:".customfield-delete-dialog-spinner",content:".customfield-delete-dialog-content",header:"#customfield-delete-dialog-heading"},events:{"click @ui.submitButton":"onSubmitClick","click @ui.cancelButton":"hide","click @ui.closeButton":"hide",show:"onShow",hide:"onHide"},initialize:function(){this.boundOnBeforeHide=this.onBeforeHide.bind(this)},onRender:function(){this.unwrapTemplate(),this.dialog=AJS.dialog2(this.el).on("show",this.onShow.bind(this)).on("hide",this.onHide.bind(this))},show:function(){this.dialog.show()},hide:function(){this.dialog.hide()},showSpinner:function(){this.getUI("spinner").removeClass("hidden")},hideSpinner:function(){this.getUI("spinner").addClass("hidden")},enableSubmitButton:function(){this.getUI("submitButton").prop("disabled",!1)},disableSubmitButton:function(){this.getUI("submitButton").prop("disabled",!0)},disableHiding:function(){this.getUI("cancelButton").prop("disabled",!0),this.getUI("closeButton").prop("disabled",!0),this.$el.attr("data-aui-modal",!0),this.dialog.on("beforeHide",this.boundOnBeforeHide)},enableHiding:function(){this.getUI("cancelButton").prop("disabled",!1),this.getUI("closeButton").prop("disabled",!1),this.$el.removeAttr("data-aui-modal"),this.dialog.off("beforeHide",this.boundOnBeforeHide)},setModel:function(e){this.model=e},isSingleDelete:function(){return 1===this.getSelectedModels().length},getSingleDeleteModel:function(){return this.model?this.model:this.collection.findWhere({isSelected:!0})},getSelectedModels:function(){return this.model?[this.model]:this.collection.where({isSelected:!0})},resetDeleteData:function(){this.collection.resetDeleteData()},sendAnalyticsEvent:function(){this.isSingleDelete()?this.sendSingleDeleteAnalyticsEvent():this.sendBulkDeleteAnalyticsEvent()},sendSingleDeleteAnalyticsEvent:function(){var e=this.getSingleDeleteModel();t.send({name:"administration.customfields.deleted",properties:{fieldId:e.get("numericId"),issuesWithValue:e.get("issuesWithValue"),lastUpdateDate:e.get("lastValueUpdate"),numberOfProjects:e.get("projectsCount"),numberOfScreens:e.get("screensCount")}})},sendBulkDeleteAnalyticsEvent:function(){this.getSelectedModels().forEach(function(e){t.send({name:"administration.customfields.bulk.deleted",properties:{fieldId:e.get("numericId"),issuesWithValue:e.get("issuesWithValue"),lastUpdateDate:e.get("lastValueUpdate"),numberOfProjects:e.get("projectsCount"),numberOfScreens:e.get("screensCount")}})})},showSuccessMessage:function(e){var t=e.deletedCustomFieldsCount,s=e.notDeletedCustomFieldsCount;1===t?i.showSuccessMsg(n.I18n.getText("admin.issuefields.customfields.delete.single.success",l.escape(this.getSingleDeleteModel().get("name"))),{closeable:!1}):i.showSuccessMsg(n.I18n.getText("admin.issuefields.customfields.delete.bulk.success",t),{closeable:!1}),s>0&&i.showErrorMsg(JIRA.Templates.Admin.Customfields.message({title:n.I18n.getText("admin.issuefields.customfields.delete.error.some.title"),description:n.I18n.getText("admin.issuefields.customfields.delete.error.some.description")}),{closeable:!1})},showErrorMessage:function(e){var t=n.I18n.getText("rest.error.internal"),s="";switch(e){case 400:t=n.I18n.getText("admin.issuefields.customfields.delete.error.zero.title"),s=n.I18n.getText("admin.issuefields.customfields.delete.error.zero.description");break;case 423:t=n.I18n.getText("admin.issuefields.customfields.delete.error.clusterlock.title"),s=n.I18n.getText("admin.issuefields.customfields.delete.error.clusterlock.description");break;case 503:t=n.I18n.getText("admin.issuefields.customfields.delete.error.settings.title"),s=n.I18n.getText("admin.issuefields.customfields.delete.error.settings.description")}i.showErrorMsg(JIRA.Templates.Admin.Customfields.message({title:t,description:s}),{closeable:!1})},onShow:function(){var e=this.getSelectedModels().length;this.getUI("content").html(JIRA.Templates.Admin.Customfields.deleteDialogContent({count:e,name:this.isSingleDelete()?this.getSingleDeleteModel().get("name"):e})),this.getUI("header").html(n.I18n.getText("admin.issuefields.customfields.delete.bulk.header",this.getSelectedModels().length))},onHide:function(){this.setModel(null)},onBeforeHide:function(e){e.preventDefault()},onSubmitClick:function(){var e=this;this.showSpinner(),this.disableSubmitButton(),this.disableHiding(),this.sendAnalyticsEvent(),s.makeRequest({url:d+"?ids="+this.getSelectedModels().map(function(e){return e.id}).join("&ids="),method:"DELETE",timeout:0,success:function(t){var i=t.deletedCustomFields,s=t.notDeletedCustomFields;e.trigger("delete:refresh"),e.showSuccessMessage({deletedCustomFieldsCount:i?i.length:0,notDeletedCustomFieldsCount:Object.keys(s||{}).length}),e.resetDeleteData()},error:function(t){var i=t.status;return e.showErrorMessage(i)},complete:function(){e.enableHiding(),e.hide(),e.hideSpinner(),e.enableSubmitButton()}})}})});